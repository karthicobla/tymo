<!DOCTYPE html>
<html lang="en" data-theme="dark"> <!-- Default theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tymr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SortableJS library for drag-and-drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js" xintegrity="sha512-TelkP3PCMJv+viJSvKqrK9dMssE8V+M0fYj/9/pGz/xG8GfC/xX/2GfC/a3fYXzPgl7HAYvT/88z-2u/pYg/A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Popper.js for positioning the onboarding tour steps -->
    <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
    <!-- NEW: Lucide Icons Library -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        :root { /* Default: Dark Theme */
            --bg-main: #111827;
            --bg-card: #1f2937;
            --bg-modal: #1f2937; /* Use card bg for modal */
            --bg-interactive: #374151;
            --bg-interactive-deep: #111827;
            --bg-interactive-hover: #4b5563;
            --bg-accent: #2563eb;
            --bg-accent-hover: #1d4ed8;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-color: #d1d5db;
            --text-muted: #9ca3af;
            --text-muted-light: #6b7280;
            --text-on-accent: #ffffff;
            --border-color: #374151;
            --border-color-strong: #4b5563;
            --accent-color: #3b82f6;
            --accent-color-light: #60a5fa;
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-scheme: dark;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }

        html[data-theme="light"] {
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --bg-modal: #ffffff;
            --bg-interactive: #e5e7eb;
            --bg-interactive-deep: #f9fafb; /* Lighter column bg */
            --bg-interactive-hover: #d1d5db;
            --bg-accent: #2563eb;
            --bg-accent-hover: #1d4ed8;
            --text-primary: #111827;
            --text-secondary: #1f2937;
            --text-color: #374151;
            --text-muted: #6b7280;
            --text-muted-light: #9ca3af;
            --text-on-accent: #ffffff;
            --border-color: #e5e7eb;
            --border-color-strong: #d1d5db;
            --accent-color: #2563eb;
            --accent-color-light: #3b82f6;
            --color-success: #16a34a;
            --color-danger: #dc2626;
            --color-danger-hover: #b91c1c;
            --color-scheme: light;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }

        html[data-theme="forest"] {
            --bg-main: #1a2e27;
            --bg-card: #2a403a;
            --bg-modal: #2a403a;
            --bg-interactive: #3a594f;
            --bg-interactive-deep: #1f3a31; /* Darker column bg */
            --bg-interactive-hover: #4c7365;
            --bg-accent: #34d399;
            --bg-accent-hover: #10b981;
            --text-primary: #f0fdf4;
            --text-secondary: #d1fae5;
            --text-color: #a7f3d0;
            --text-muted: #6ee7b7;
            --text-muted-light: #34d399;
            --text-on-accent: #064e3b;
            --border-color: #3a594f;
            --border-color-strong: #4c7365;
            --accent-color: #34d399;
            --accent-color-light: #6ee7b7;
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-scheme: dark;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }

        html[data-theme="slate"] {
            --bg-main: #262626; /* neutral-800 */
            --bg-card: #404040; /* neutral-700 */
            --bg-modal: #404040;
            --bg-interactive: #525252; /* neutral-600 */
            --bg-interactive-deep: #171717; /* neutral-900 */
            --bg-interactive-hover: #737373; /* neutral-500 */
            --bg-accent: #a3a3a3; /* neutral-400 */
            --bg-accent-hover: #d4d4d4; /* neutral-300 */
            --text-primary: #f5f5f5; /* neutral-100 */
            --text-secondary: #e5e5e5; /* neutral-200 */
            --text-color: #d4d4d4; /* neutral-300 */
            --text-muted: #a3a3a3; /* neutral-400 */
            --text-muted-light: #737373; /* neutral-500 */
            --text-on-accent: #171717; /* neutral-900 */
            --border-color: #525252; /* neutral-600 */
            --border-color-strong: #737373; /* neutral-500 */
            --accent-color: #a3a3a3; /* neutral-400 */
            --accent-color-light: #d4d4d4; /* neutral-300 */
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-scheme: dark;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }


        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s, background-image 0.3s;
            background-color: var(--bg-main);
            color: var(--text-color);
            background-image: var(--body-bg-image);
            background-size: cover;
            background-attachment: fixed;
        }

        /* --- Semantic Color Classes --- */
        .body-bg { background-color: var(--bg-main); }
        .text-color { color: var(--text-color); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-muted-light { color: var(--text-muted-light); }
        .text-on-accent { color: var(--text-on-accent); }
        
        .card-bg { 
            background-color: var(--bg-card); 
            backdrop-filter: var(--card-backdrop-filter);
            -webkit-backdrop-filter: var(--card-backdrop-filter);
            transition: background-color 0.3s;
        }
        .modal-bg { 
            background-color: var(--bg-modal); 
            backdrop-filter: var(--modal-backdrop-filter);
            -webkit-backdrop-filter: var(--modal-backdrop-filter);
            transition: background-color 0.3s;
        }
        .input-bg { background-color: var(--bg-interactive); color: var(--text-primary); }
        .input-bg:focus {
            --tw-ring-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .select-bg {
            background-color: var(--bg-interactive); 
            color: var(--text-primary);
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .bg-interactive { background-color: var(--bg-interactive); }
        .bg-interactive-deep { background-color: var(--bg-interactive-deep); }
        .column-bg { background-color: var(--bg-interactive-deep); }

        .border-color { border-color: var(--border-color); }
        .border-color-strong { border-color: var(--border-color-strong); }

        .btn {
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-primary {
            background-color: var(--bg-accent);
            color: var(--text-on-accent);
        }
        .btn-primary:hover {
            background-color: var(--bg-accent-hover);
        }
        .btn-secondary {
            background-color: var(--bg-interactive);
            color: var(--text-secondary);
        }
        .btn-secondary:hover {
            background-color: var(--bg-interactive-hover);
        }
        .btn-danger-text {
            color: var(--color-danger);
        }
        .btn-danger-text:hover {
            color: var(--color-danger-hover);
        }
        .btn-danger-solid {
            background-color: var(--color-danger);
            color: var(--text-on-accent);
        }
        .btn-danger-solid:hover {
            background-color: var(--color-danger-hover);
        }
        .btn-neutral {
            background-color: var(--bg-interactive);
            color: var(--text-color);
        }
        .btn-neutral:hover {
            background-color: var(--bg-interactive-hover);
        }
        .text-accent-light { color: var(--accent-color-light); }
        .text-accent { color: var(--accent-color); }
        .hover-text-accent:hover { color: var(--accent-color); }
        .text-success { color: var(--color-success); }
        .text-danger { color: var(--color-danger); }
        .hover-text-success:hover { color: var(--color-success); }
        .hover-text-accent-light:hover { color: var(--accent-color-light); }
        .hover-text-danger:hover { color: var(--color-danger); }
        
        input[type="datetime-local"] {
            color-scheme: var(--color-scheme);
        }

        /* Modify color input style */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 2.5rem; /* 40px */
            padding: 0.25rem; /* p-1 */
            border-width: 1px;
            border-color: var(--border-color-strong);
            background-color: var(--bg-interactive);
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 0.375rem; /* rounded-md */
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.375rem; /* rounded-md */
        }
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 0.375rem; /* rounded-md */
        }
        
        .theme-btn {
            transition: all 0.2s;
            color: var(--text-muted); /* Default icon color */
        }
        .theme-btn:hover {
            color: var(--text-primary); /* Hover icon color */
            background-color: var(--bg-interactive-hover);
        }
        .theme-btn.active-theme {
            background-color: var(--accent-color);
            color: var(--text-on-accent);
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-interactive-deep);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--text-muted-light);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        .modal {
            display: none;
        }
        .modal.flex {
            display: flex;
        }

        /* --- Toast Animations --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }
        .animate-fadeOut {
            animation: fadeOut 0.5s ease-in forwards;
        }

        /* --- SortableJS Styles --- */
        .group-container {
            width: 100%; /* Ensure groups stack vertically */
        }
        .card-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 0.75rem; /* 12px */
            min-height: 50px; /* Drop area for empty groups */
        }
        .group-header {
            cursor: grab;
            user-select: none;
        }
        .group-header:active {
            cursor: grabbing;
        }
        /* Ghost class for dragged item */
        .sortable-ghost {
            opacity: 0.4;
            background: var(--bg-interactive);
        }
        .sortable-drag {
            opacity: 0.95;
            transform: rotate(2deg);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.15);
        }

        /* --- NEW: Onboarding Styles --- */
        .onboarding-highlight {
            position: relative;
            z-index: 195 !important; /* Above overlay, below step */
            transition: all 0.3s ease;
            box-shadow: 0 0 0 4px var(--accent-color), 0 0 20px 10px var(--accent-color);
            border-radius: 8px; /* Match element rounding */
        }
        /* Make sure pseudo-elements don't block the highlight */
        .onboarding-highlight::before,
        .onboarding-highlight::after {
            z-index: -1;
        }

        #onboardingArrow,
        #onboardingArrow::before {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--bg-modal);
        }
        #onboardingArrow {
            visibility: hidden;
        }
        #onboardingArrow::before {
            visibility: visible;
            content: '';
            transform: rotate(45deg);
        }
        
        /* Popper placement styling */
        #onboardingStep[data-popper-placement^='top'] > #onboardingArrow {
            bottom: -4px;
        }
        #onboardingStep[data-popper-placement^='bottom'] > #onboardingArrow {
            top: -4px;
        }
        #onboardingStep[data-popper-placement^='left'] > #onboardingArrow {
            right: -4px;
        }
        #onboardingStep[data-popper-placement^='right'] > #onboardingArrow {
            left: -4px;
        }
        /* --- END: Onboarding Styles --- */
    </style>
</head>
<body class="antialiased body-bg text-color">

    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-6 flex items-center justify-between">
            <h1 class="text-6xl font-bold text-primary">tymr</h1>
            
            <div id="themeSwitcher" class="flex items-center gap-1 bg-interactive-deep p-1 rounded-lg">
                <button class="theme-btn p-1 rounded-md" data-theme="dark" title="Dark Theme">
                    <i data-lucide="moon" width="20" height="20"></i>
                </button>
                <button class="theme-btn p-1 rounded-md" data-theme="light" title="Light Theme">
                    <i data-lucide="sun" width="20" height="20"></i>
                </button>
                <button class="theme-btn p-1 rounded-md" data-theme="forest" title="Forest Theme">
                    <i data-lucide="trees" width="20" height="20"></i>
                </button>
                <button class="theme-btn p-1 rounded-md" data-theme="slate" title="Slate Theme">
                    <i data-lucide="layout-grid" width="20" height="20"></i>
                </button>
            </div>

            <div class="flex items-center gap-2">
                <button id="addDateBtn" class="btn btn-primary font-medium py-2 px-4 rounded-lg text-sm flex items-center gap-1.5">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Add Date
                </button>
                <button id="settingsBtn" class="btn btn-secondary font-medium p-2 rounded-lg text-sm">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <!-- NEW: Help/Onboarding Button -->
                <button id="helpBtn" class="btn btn-secondary font-medium p-2 rounded-lg text-sm" title="Show Help">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Countdown Container -->
        <!-- UPDATED: This container now holds groups, which in turn hold cards -->
        <div id="countdownContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
            <!-- Widgets and groups will be dynamically inserted here -->
        </div>
    </div>

    <!-- Add/Edit Date Modal -->
    <div id="dateModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="modal-bg rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-color">
                <h2 id="modalTitle" class="text-lg font-semibold text-primary">Add New Date</h2>
                <button id="closeModalBtn" class="text-muted hover:text-primary">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto space-y-6">
                <input type="hidden" id="dateId">

                <!-- Date Title -->
                <div>
                    <label for="dateTitle" class="block text-sm font-medium text-color mb-1.5">Date Title</label>
                    <input type="text" id="dateTitle" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., Launch Project Orion">
                </div>

                <!-- Notes / Description -->
                <div>
                    <label for="dateNotes" class="block text-sm font-medium text-color mb-1.5">Notes / Description</label>
                    <textarea id="dateNotes" rows="3" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="Add more details about this goal..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Target Date -->
                    <div>
                        <label for="dateTarget" class="block text-sm font-medium text-color mb-1.5">Target Date & Time</label>
                        <input type="datetime-local" id="dateTarget" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none">
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="goalCategory" class="block text-sm font-medium text-color mb-1.5">Category</label>
                        <input type="text" id="dateCategory" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., Personal, Work" list="categorySuggestions">
                        <datalist id="categorySuggestions">
                            <!-- Dynamically populated. Add common suggestions. -->
                            <option value="Personal"></option>
                            <option value="Work"></option>
                            <option value="Birthday"></option> <!-- ADDED -->
                            <option value="Anniversary"></option> <!-- ADDED -->
                            <option value="Health"></option>
                            <option value="Finance"></option>
                            <option value="Learn"></option>
                            <option value="Travel"></option>
                            <option value="Home"></option>
                        </datalist>
                    </div>
                    
                    <!-- Icon Name -->
                    <div>
                        <label for="dateIconName" class="block text-sm font-medium text-color mb-1.5">Icon Name (from lucide.dev)</label>
                        <input type="text" id="dateIconName" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., rocket, award" list="iconSuggestions">
                        <datalist id="iconSuggestions">
                            <!-- Common icon suggestions (truncated for brevity) -->
                            <option value="rocket"></option>
                            <option value="award"></option>
                            <option value="book-open"></option>
                            <option value="briefcase"></option>
                            <option value="calendar"></option>
                            <option value="cake"></option> <!-- ADDED -->
                            <option value="gift"></option> <!-- ADDED -->
                            <option value="calendar-heart"></option> <!-- ADDED -->
                            <option value="heart"></option>
                            <option value="home"></option>
                            <option value="flag"></option>
                            <option value="graduation-cap"></option>
                            <option value="dollar-sign"></option>
                            <option value="globe-2"></option>
                            <option value="user"></option>
                            <option value="star"></option>
                            <option value="target"></option>
                            <option value="trending-up"></option>
                        </datalist>
                    </div>

                    <!-- Group -->
                    <div>
                        <label for="dateGroup" class="block text-sm font-medium text-color mb-1.5">Group</label>
                        <input type="text" id="dateGroup" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., Q4 Projects" list="groupSuggestions">
                        <datalist id="groupSuggestions">
                            <!-- Dynamically populated -->
                        </datalist>
                    </div>

                    <!-- UPDATED: Category Color -->
                    <div>
                        <label for="dateCategoryColor" class="block text-sm font-medium text-color mb-1.5">Icon & Category Color</label>
                        <input type="color" id="dateCategoryColor" value="#374151"> <!-- Default value -->
                    </div>
                </div>

                <!-- Milestones (Subtasks) -->
                <div id="milestoneSection"> <!-- ADDED ID -->
                    <h3 class="text-sm font-medium text-color mb-2">Key Results (Milestones)</h3>
                    <div id="milestonesContainer" class="space-y-2">
                        <!-- Milestones will be dynamically inserted here -->
                    </div>
                    <!-- UPDATED: Milestone add section -->
                    <div class="flex items-center gap-2 mt-2">
                        <input type="text" id="newMilestoneInput" class="input-bg flex-1 border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="Add a new milestone...">
                        <button id="addMilestoneBtn" type="button" class="btn btn-secondary p-2.5 rounded-lg text-accent-light hover:text-accent">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <!-- END UPDATED: Milestone add section -->
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-4 bg-interactive-deep bg-opacity-50 border-t border-color rounded-b-xl">
                <button id="deleteDateBtn" type="button" class="btn-danger-text font-medium text-sm px-3 py-2 rounded-lg">Delete Date</button>
                <div>
                    <button id="cancelModalBtn" type="button" class="btn btn-neutral font-medium rounded-lg text-sm px-5 py-2.5 mr-2">Cancel</button>
                    <button id="saveDateBtn" type="button" class="btn btn-primary font-medium rounded-lg text-sm px-5 py-2.5">Save Date</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="modal-bg rounded-xl shadow-2xl w-full max-w-md">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-color">
                <h2 class="text-lg font-semibold text-primary">Settings</h2>
                <button id="closeSettingsBtn" class="text-muted hover:text-primary">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-6 space-y-4">
                <!-- NEW: Column Count Setting -->
                <div>
                    <label for="columnCountSelect" class="block text-sm font-medium text-color mb-1.5">Columns on Wide Screen</label>
                    <select id="columnCountSelect" class="select-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none">
                        <option value="1">1 Column</option>
                        <option value="2">2 Columns (Default)</option>
                        <option value="3">3 Columns</option>
                        <option value="4">4 Columns</option>
                    </select>
                </div>
                <!-- END: Column Count Setting -->
                <p class="text-sm text-muted pt-2">Export all your dates to a JSON file as a backup, or import them on another device.</p>
                <button id="exportDataBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg text-sm flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Export Dates (.json)
                </button>
                <div>
                    <label for="importFile" class="btn btn-primary w-full font-medium py-2.5 px-4 rounded-lg text-sm flex items-center justify-center gap-2 cursor-pointer">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        Import Dates (.json)
                    </label>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal fixed inset-0 z-[100] items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="modal-bg rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
                <h3 id="confirmTitle" class="text-lg font-semibold text-primary">Are you sure?</h3>
                <p id="confirmMessage" class="mt-2 text-sm text-muted">This action cannot be undone.</p>
            </div>
            <div class="flex justify-end gap-3 p-4 bg-interactive-deep bg-opacity-50 rounded-b-xl border-t border-color">
                <button id="confirmCancel" class="btn btn-neutral font-medium rounded-lg text-sm px-4 py-2">Cancel</button>
                <button id="confirmDelete" class="btn btn-danger-solid font-medium rounded-lg text-sm px-4 py-2">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-[200] w-full max-w-xs space-y-3">
        <!-- Toasts will be dynamically inserted here -->
    </div>

    <!-- NEW: Onboarding Tour -->
    <div id="onboardingOverlay" class="modal fixed inset-0 z-[190] bg-black bg-opacity-75"></div>
    <div id="onboardingStep" class="modal absolute z-[200] modal-bg rounded-lg shadow-xl w-full max-w-xs p-4" data-step-index="0">
        <p id="onboardingText" class="text-sm text-color mb-4">Welcome to Tymr!</p>
        <div class="flex items-center justify-between">
            <button id="onboardingSkip" class="text-sm text-muted hover:text-primary px-3 py-1.5 rounded-lg">Skip</button>
            <div class="flex gap-3">
                <button id="onboardingPrev" class="btn btn-neutral text-sm px-3 py-1.5">Prev</button>
                <button id="onboardingNext" class="btn btn-primary text-sm px-3 py-1.5">Next</button>
            </div>
        </div>
        <!-- Arrow element for pointing -->
        <div id="onboardingArrow" data-popper-arrow></div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // UI Elements
                countdownContainer: document.getElementById('countdownContainer'),
                addDateBtn: document.getElementById('addDateBtn'),
                settingsBtn: document.getElementById('settingsBtn'),
                themeSwitcher: document.getElementById('themeSwitcher'),
                helpBtn: document.getElementById('helpBtn'), // NEW

                // Goal Modal
                dateModal: document.getElementById('dateModal'),
                modalTitle: document.getElementById('modalTitle'),
                closeModalBtn: document.getElementById('closeModalBtn'),
                cancelModalBtn: document.getElementById('cancelModalBtn'),
                saveDateBtn: document.getElementById('saveDateBtn'),
                deleteDateBtn: document.getElementById('deleteDateBtn'),
                dateId: document.getElementById('dateId'),
                dateTitle: document.getElementById('dateTitle'),
                dateNotes: document.getElementById('dateNotes'),
                dateTarget: document.getElementById('dateTarget'),
                // goalPriority: (REMOVED)
                dateCategory: document.getElementById('dateCategory'),
                dateCategoryColor: document.getElementById('dateCategoryColor'), // NEW
                dateIconName: document.getElementById('dateIconName'),
                dateGroup: document.getElementById('dateGroup'),
                categorySuggestions: document.getElementById('categorySuggestions'),
                groupSuggestions: document.getElementById('groupSuggestions'),

                // Milestones
                milestonesContainer: document.getElementById('milestonesContainer'),
                newMilestoneInput: document.getElementById('newMilestoneInput'),
                addMilestoneBtn: document.getElementById('addMilestoneBtn'),
                milestoneSection: document.getElementById('milestoneSection'), // NEW

                // Settings Modal
                settingsModal: document.getElementById('settingsModal'),
                closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                exportDataBtn: document.getElementById('exportDataBtn'),
                importFile: document.getElementById('importFile'),
                columnCountSelect: document.getElementById('columnCountSelect'), // NEW

                // Confirm Modal
                confirmModal: document.getElementById('confirmModal'),
                confirmTitle: document.getElementById('confirmTitle'),
                confirmMessage: document.getElementById('confirmMessage'),
                confirmCancel: document.getElementById('confirmCancel'),
                confirmDelete: document.getElementById('confirmDelete'),
                
                // Toast
                toastContainer: document.getElementById('toastContainer'),

                // NEW: Onboarding
                onboardingOverlay: document.getElementById('onboardingOverlay'),
                onboardingStep: document.getElementById('onboardingStep'),
                onboardingText: document.getElementById('onboardingText'),
                onboardingSkip: document.getElementById('onboardingSkip'),
                onboardingPrev: document.getElementById('onboardingPrev'),
                onboardingNext: document.getElementById('onboardingNext'),
                onboardingArrow: document.getElementById('onboardingArrow'),

                // App State
                dates: [],
                groupOrder: [], // NEW: To store the order of groups
                timers: [],
                currentMilestones: [],
                _confirmCallback: null,
                sortableGroups: null, // NEW: Sortable instance for groups
                sortableCards: [], // NEW: Array of Sortable instances for cards
                columnCount: 2, // NEW: Default column count

                // NEW: Onboarding State
                tourSteps: [],
                currentTourStep: 0,
                popperInstance: null,

                init() {
                    this.loadTheme();
                    this.loadDates();
                    this.loadAndApplyColumnCount(); // NEW
                    this.renderAllDates();
                    this.updateDatalists();
                    // this.startTimers(); // Moved to renderAllDates
                    this.attachEventListeners();
                    this.initThemes();
                    this.initTourSteps(); // NEW
                    this.startTour(); // NEW
                    lucide.createIcons(); // NEW: Initial icon render
                },

                attachEventListeners() {
                    this.addDateBtn.addEventListener('click', () => this.openModal());
                    this.settingsBtn.addEventListener('click', () => this.openSettings());
                    this.helpBtn.addEventListener('click', () => this.startTour(true)); // NEW: true forces restart
                    
                    // Goal Modal
                    this.closeModalBtn.addEventListener('click', () => this.closeModal());
                    this.cancelModalBtn.addEventListener('click', () => this.closeModal());
                    this.saveDateBtn.addEventListener('click', () => this.saveDate());
                    this.deleteDateBtn.addEventListener('click', () => this.handleDeleteDate());
                    // NEW: Listen for category changes to update the modal UI
                    this.dateCategory.addEventListener('input', () => this.updateModalForCategory());

                    // Milestones
                    this.addMilestoneBtn.addEventListener('click', () => this.addMilestone());
                    this.newMilestoneInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addMilestone();
                        }
                    });
                    this.milestonesContainer.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-milestone')) {
                            const id = e.target.closest('.milestone-item').dataset.id;
                            this.deleteMilestone(id);
                        } else if (e.target.closest('.milestone-checkbox')) {
                            const id = e.target.closest('.milestone-item').dataset.id;
                            this.toggleMilestone(id);
                        }
                    });
                    
                    // Settings Modal
                    this.closeSettingsBtn.addEventListener('click', () => this.closeSettings());
                    this.exportDataBtn.addEventListener('click', () => this.exportData());
                    this.importFile.addEventListener('change', (e) => this.importData(e));
                    this.columnCountSelect.addEventListener('change', (e) => this.setColumnCount(e.target.value)); // NEW

                    // Confirm Modal
                    this.confirmCancel.addEventListener('click', () => this.closeConfirm());
                    this.confirmDelete.addEventListener('click', () => this.runConfirm());

                    // Card actions (event delegation on the container)
                    this.countdownContainer.addEventListener('click', (e) => {
                        const card = e.target.closest('[data-id]');
                        if (!card) return;
                        
                        const id = card.dataset.id;

                        if (e.target.closest('.edit-card')) {
                            this.openModal(id);
                        } else if (e.target.closest('.delete-card')) {
                            this.handleDeleteCard(id);
                        } else if (e.target.closest('.complete-card')) {
                            this.toggleComplete(id);
                        }
                    });

                    // NEW: Onboarding
                    this.onboardingSkip.addEventListener('click', () => this.endTour());
                    this.onboardingNext.addEventListener('click', () => this.nextTourStep());
                    this.onboardingPrev.addEventListener('click', () => this.prevTourStep());
                },

                initThemes() {
                    this.themeSwitcher.addEventListener('click', (e) => {
                        const themeBtn = e.target.closest('.theme-btn');
                        if (themeBtn) {
                            this.setTheme(themeBtn.dataset.theme);
                        }
                    });
                },

                loadTheme() {
                    const savedTheme = localStorage.getItem('tymrTheme') || 'dark';
                    this.setTheme(savedTheme);
                },

                setTheme(themeName) {
                    document.documentElement.dataset.theme = themeName;
                    localStorage.setItem('tymrTheme', themeName);

                    // Update active button state
                    this.themeSwitcher.querySelectorAll('.theme-btn').forEach(btn => {
                        btn.classList.toggle('active-theme', btn.dataset.theme === themeName);
                    });
                },
                
                loadDates() {
                    const datesData = localStorage.getItem('countdownDates');
                    this.dates = datesData ? JSON.parse(datesData) : [];
                    const orderData = localStorage.getItem('tymrGroupOrder');
                    this.groupOrder = orderData ? JSON.parse(orderData) : [];
                },

                // NEW: Just saves goal data
                saveDatesData() {
                    localStorage.setItem('countdownDates', JSON.stringify(this.dates));
                },

                // NEW: Just saves group order
                saveGroupOrderData() {
                    localStorage.setItem('tymrGroupOrder', JSON.stringify(this.groupOrder));
                },

                // UPDATED: Renamed from saveGoals, now calls saveDatesData and re-renders
                saveAndRender() {
                    this.saveDatesData();
                    this.renderAllDates();
                    this.updateDatalists();
                },

                openModal(id = null) {
                    this.resetModal();
                    if (id) {
                        const date = this.dates.find(g => g.id === id);
                        if (date) {
                            this.modalTitle.textContent = 'Edit Date';
                            this.dateId.value = date.id;
                            this.dateTitle.value = date.title;
                            this.dateNotes.value = date.notes || '';
                            this.dateTarget.value = date.date ? date.date.substring(0, 16) : '';
                            // this.goalPriority.value = goal.priority || 'Medium'; // REMOVED
                            this.dateCategory.value = date.category || '';
                            this.dateCategoryColor.value = date.categoryColor || '#374151'; // NEW
                            this.dateIconName.value = date.iconName || '';
                            this.dateGroup.value = date.group || '';
                            this.currentMilestones = JSON.parse(JSON.stringify(date.milestones || []));
                            this.deleteDateBtn.style.display = 'block';
                        }
                    } else {
                        this.modalTitle.textContent = 'Add New Date';
                        this.deleteDateBtn.style.display = 'none';
                    }
                    this.renderMilestones();
                    this.updateModalForCategory(); // NEW: Update UI based on category
                    this.dateModal.classList.add('flex');
                    lucide.createIcons(); // NEW: Render icons in modal
                },

                closeModal() {
                    this.dateModal.classList.remove('flex');
                    this.resetModal();
                },

                resetModal() {
                    this.modalTitle.textContent = 'Add New Date';
                    this.dateId.value = '';
                    this.dateTitle.value = '';
                    this.dateNotes.value = '';
                    this.dateTarget.value = '';
                    // this.goalPriority.value = 'Medium'; // REMOVED
                    this.dateCategory.value = '';
                    this.dateCategoryColor.value = '#374151'; // NEW
                    this.dateIconName.value = '';
                    this.dateGroup.value = '';
                    this.currentMilestones = [];
                    this.milestonesContainer.innerHTML = '';
                    this.newMilestoneInput.value = '';
                },

                // NEW: Show/hide date/datetime input based on category
                updateModalForCategory() {
                    const categoryLabel = document.querySelector('label[for="dateTarget"]');
                    // NEW: Check for birthday or anniversary
                    const categoryLower = this.dateCategory.value.trim().toLowerCase();
                    const isBirthday = categoryLower === 'birthday';
                    const isAnniversary = categoryLower === 'anniversary';
                    const isSpecialDate = isBirthday || isAnniversary;
                    
                    // NEW: Find the milestone section title
                    const milestoneTitle = this.milestoneSection.querySelector('h3'); // Target the h3

                    // NEW: Show milestone section for all, but change title
                    this.milestoneSection.style.display = 'block'; // Always show
                    if (isSpecialDate) { // UPDATED: Use isSpecialDate
                        if (milestoneTitle) milestoneTitle.textContent = 'Checklist'; // Change title
                    } else {
                        if (milestoneTitle) milestoneTitle.textContent = 'Key Results (Milestones)'; // Reset title
                    }

                    // REMOVED logic that hid the milestone section
                    /*
                    */

                    if (isSpecialDate) { // UPDATED: Use isSpecialDate
                        // NEW: Set label based on type
                        if (isBirthday) {
                            categoryLabel.textContent = 'Birthday (Date of Birth)';
                        } else if (isAnniversary) {
                            categoryLabel.textContent = 'Anniversary Date';
                        }
                        this.dateTarget.type = 'date';
                        // If it was a datetime, strip the time part
                        if (this.dateTarget.value.includes('T')) {
                            this.dateTarget.value = this.dateTarget.value.split('T')[0];
                        }
                    } else {
                        categoryLabel.textContent = 'Target Date & Time';
                        this.dateTarget.type = 'datetime-local';
                        // If it was just a date, add a default time
                        if (this.dateTarget.value && !this.dateTarget.value.includes('T')) {
                            this.dateTarget.value = `${this.dateTarget.value}T12:00`;
                        }
                    }
                },

                saveDate() {
                    const id = this.dateId.value;
                    const title = this.dateTitle.value.trim();
                    const target = this.dateTarget.value;

                    if (!title || !target) {
                        this.showToast('Please fill in both Date Title and Target Date.', 'error');
                        return;
                    }

                    const dateData = {
                        title: title,
                        notes: this.dateNotes.value.trim(),
                        date: target,
                        // priority: this.goalPriority.value, // REMOVED
                        category: this.dateCategory.value.trim(),
                        categoryColor: this.dateCategoryColor.value, // NEW
                        iconName: this.dateIconName.value.trim(),
                        group: this.dateGroup.value.trim() || 'General',
                        milestones: this.currentMilestones,
                        status: this.dates.find(g => g.id === id)?.status || 'Pending'
                    };

                    if (id) {
                        const index = this.dates.findIndex(g => g.id === id);
                        if (index !== -1) {
                            this.dates[index] = { ...this.dates[index], ...dateData };
                        }
                    } else {
                        this.dates.push({
                            ...dateData,
                            id: `goal_${Date.now()}`
                        });
                    }

                    this.saveAndRender(); // UPDATED
                    this.closeModal();
                },
                
                handleDeleteDate() {
                    const id = this.dateId.value;
                    if (!id) return;
                    
                    this.showConfirm(
                        'Delete Date?',
                        'Are you sure you want to delete this date? This action cannot be undone.',
                        () => {
                            this.dates = this.dates.filter(g => g.id !== id);
                            this.saveAndRender(); // UPDATED
                            this.closeModal();
                        }
                    );
                },

                handleDeleteCard(id) {
                    if (!id) return;
                    
                    this.showConfirm(
                        'Delete Date?',
                        'Are you sure you want to delete this date? This action cannot be undone.',
                        () => {
                            this.dates = this.dates.filter(g => g.id !== id);
                            this.saveAndRender(); // UPDATED
                        }
                    );
                },

                toggleComplete(id) {
                    const date = this.dates.find(g => g.id === id);
                    if (date) {
                        date.status = date.status === 'Completed' ? 'Pending' : 'Completed';
                        this.saveAndRender(); // UPDATED
                    }
                },

                renderMilestones() {
                    this.milestonesContainer.innerHTML = '';
                    if (this.currentMilestones.length === 0) {
                        this.milestonesContainer.innerHTML = '<p class="text-xs text-muted italic">No milestones added yet.</p>';
                        return;
                    }
                    this.currentMilestones.forEach(milestone => {
                        this.milestonesContainer.appendChild(this.createMilestoneElement(milestone));
                    });
                },
                
                createMilestoneElement(milestone) {
                    const div = document.createElement('div');
                    div.className = 'milestone-item flex items-center justify-between bg-interactive p-2 rounded-md';
                    div.dataset.id = milestone.id;
                    
                    const checked = milestone.completed ? 'checked' : '';
                    const textClass = milestone.completed ? 'line-through text-muted-light' : 'text-secondary';

                    // UPDATED: Delete button icon
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <input type="checkbox" ${checked} class="milestone-checkbox form-checkbox h-4 w-4 bg-interactive border-color-strong text-accent-light rounded focus:ring-accent-light focus:ring-offset-gray-800">
                            <span class="text-sm ${textClass}">${this.escapeHTML(milestone.text)}</span>
                        </div>
                        <button type="button" class="delete-milestone text-muted-light hover-text-danger p-1">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    `;
                    return div;
                    this.currentMilestones.forEach(milestone => {
                        this.milestonesContainer.appendChild(this.createMilestoneElement(milestone));
                    });
                    lucide.createIcons(); // NEW: Render milestone icons
                },
                
                addMilestone() {
                    const text = this.newMilestoneInput.value.trim();
                    if (text) {
                        this.currentMilestones.push({
                            id: `ms_${Date.now()}`,
                            text: text,
                            completed: false
                        });
                        this.newMilestoneInput.value = '';
                        this.renderMilestones();
                    }
                },

                deleteMilestone(id) {
                    this.currentMilestones = this.currentMilestones.filter(ms => ms.id !== id);
                    this.renderMilestones();
                },
                
                toggleMilestone(id) {
                    const milestone = this.currentMilestones.find(ms => ms.id === id); // Corrected find
                    if (milestone) {
                        milestone.completed = !milestone.completed;
                        this.renderMilestones(); // Re-render to apply line-through
                    }
                },

                openSettings() {
                    this.settingsModal.classList.add('flex');
                    lucide.createIcons(); // NEW: Render icons in modal
                },

                closeSettings() {
                    this.settingsModal.classList.remove('flex');
                },
                
                exportData() {
                    if (this.dates.length === 0) {
                        this.showToast('No dates to export.', 'error');
                        return;
                    }
                    const dataStr = JSON.stringify(this.dates, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tymr_dates_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.closeSettings();
                    this.showToast('Dates exported successfully.', 'success');
                },
                
                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedDates = JSON.parse(e.target.result);
                            if (Array.isArray(importedDates) && importedDates.every(g => g.id && g.title && g.date)) {
                                this.showConfirm(
                                    'Import Dates?',
                                    'This will overwrite all current dates. Are you sure you want to proceed?',
                                    () => {
                                        this.dates = importedDates;
                                        this.groupOrder = []; // Reset group order, will be regenerated
                                        this.saveAndRender(); // UPDATED
                                        this.closeSettings();
                                        event.target.value = null; // Reset file input
                                        this.showToast('Dates imported successfully.', 'success');
                                    }
                                );
                            } else {
                                this.showToast('Invalid file format. Could not import.', 'error');
                            }
                        } catch (err) {
                            console.error('Error importing data:', err);
                            this.showToast('Failed to read or parse file.', 'error');
                        } // <-- FIX: Added closing brace for catch
                    }; // <-- FIX: Added closing brace and semicolon for reader.onload
                    reader.readAsText(file); // <-- FIX: Added this line to trigger the file read
                },

                // --- NEW: Onboarding Tour Methods ---

                initTourSteps() {
                    this.tourSteps = [
                        {
                            selector: 'h1',
                            text: "Welcome to Tymr! This is your personal countdown dashboard.",
                            placement: 'bottom-start'
                        },
                        {
                            selector: '#themeSwitcher',
                            text: "Choose your favorite look. The theme is saved automatically.",
                            placement: 'bottom'
                        },
                        {
                            selector: '#addDateBtn',
                            text: "Click here to add your first countdown. You can add goals, birthdays, and more.",
                            placement: 'bottom-end'
                        },
                        {
                            selector: '#settingsBtn',
                            text: "Here you can export a backup of your dates or import them on another device.",
                            placement: 'bottom-end'
                        },
                        {
                            selector: '#helpBtn',
                            text: "You can restart this guide anytime by clicking this help icon.",
                            placement: 'bottom-end'
                        }
                        /* MOVED: The step below was removed as requested to end the tour at the help icon.
                        {
                            // This step is dynamic. It will try to find a card, then a group, then the empty state.
                            selector: '[data-id]', // Try to find a card first
                            text: "Your countdowns will appear here as cards. You can drag and drop them to re-order.",
                            placement: 'bottom',
                            fallbackSelector: '.group-header', // If no card, find a group header
                            fallbackText: "Your cards are organized into groups. You can drag cards between groups, or drag the group headers to re-order entire sections.",
                            fallbackPlacement: 'bottom',
                            finalFallbackSelector: '#countdownContainer', // If nothing, point to the container
                            finalFallbackText: "This is where your countdowns and groups will appear once you add them.",
                            finalFallbackPlacement: 'right'
                        }
                        */
                    ];
                },

                startTour(force = false) {
                    const hasSeenTour = localStorage.getItem('tymrTourSeen');
                    if (hasSeenTour && !force) {
                        this.endTour(); // Ensure it's hidden
                        return;
                    }
                    this.showTourStep(0);
                },

                endTour() {
                    if (this.popperInstance) this.popperInstance.destroy();
                    document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight'));
                    
                    this.onboardingStep.classList.remove('flex');
                    this.onboardingOverlay.classList.remove('flex');
                    localStorage.setItem('tymrTourSeen', 'true');
                },

                showTourStep(index) {
                    // Clean up previous step
                    if (this.popperInstance) this.popperInstance.destroy();
                    document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight'));

                    if (index >= this.tourSteps.length) {
                        this.endTour();
                        return;
                    }

                    this.currentTourStep = index;
                    let step = this.tourSteps[index];
                    
                    let targetElement = document.querySelector(step.selector);
                    let text = step.text;
                    let placement = step.placement;

                    // --- Handle Fallbacks ---
                    if (!targetElement && step.fallbackSelector) {
                        targetElement = document.querySelector(step.fallbackSelector);
                        if (targetElement) {
                            text = step.fallbackText || text;
                            placement = step.fallbackPlacement || placement;
                        }
                    }
                    if (!targetElement && step.finalFallbackSelector) {
                        targetElement = document.querySelector(step.finalFallbackSelector);
                        if (targetElement) {
                            text = step.finalFallbackText || text;
                            placement = step.finalFallbackPlacement || placement;
                        }
                    }
                    // --- End Fallbacks ---
                    
                    this.onboardingText.textContent = text;
                    this.onboardingStep.classList.add('flex');
                    this.onboardingOverlay.classList.add('flex');

                    if (targetElement) {
                        targetElement.classList.add('onboarding-highlight');
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

                        this.popperInstance = Popper.createPopper(targetElement, this.onboardingStep, {
                            placement: placement,
                            modifiers: [
                                { name: 'offset', options: { offset: [0, 12] } }, // Add some space
                                { name: 'arrow', options: { element: this.onboardingArrow } }
                            ]
                        });
                    } else {
                        // No target found, just center the modal
                        this.onboardingStep.style.top = '50%';
                        this.onboardingStep.style.left = '50%';
                        this.onboardingStep.style.transform = 'translate(-50%, -50%)';
                    }

                    // Update buttons
                    this.onboardingPrev.style.display = (index === 0) ? 'none' : 'block';
                    this.onboardingNext.textContent = (index === this.tourSteps.length - 1) ? 'Done' : 'Next';
                },

                nextTourStep() {
                    this.showTourStep(this.currentTourStep + 1);
                },

                prevTourStep() {
                    this.showTourStep(this.currentTourStep - 1);
                },

                // --- END: Onboarding Tour Methods ---


                showConfirm(title, message, callback) {
                    this.confirmTitle.textContent = title;
                    this.confirmMessage.textContent = message;
                    this._confirmCallback = callback;
                    this.confirmModal.classList.add('flex');
                },

                closeConfirm() {
                    this.confirmModal.classList.remove('flex');
                    this._confirmCallback = null;
                },

                runConfirm() {
                    if (this._confirmCallback) {
                        this._confirmCallback();
                    }
                    this.closeConfirm();
                },

                showToast(message, type = 'error') {
                    const toast = document.createElement('div');
                    let icon = '';
                    let classes = '';

                    if (type === 'error') {
                        classes = 'bg-red-600 text-white';
                        icon = `<i data-lucide="alert-circle" class="w-5 h-5"></i>`;
                    } else { // 'success' or default
                        classes = 'bg-green-600 text-white';
                        icon = `<i data-lucide="check-circle" class="w-5 h-5"></i>`;
                    }

                    toast.className = `flex items-center gap-3 w-full p-4 rounded-lg shadow-lg ${classes}`;
                    toast.classList.add('animate-fadeIn');
                    toast.innerHTML = `
                        <div class="shrink-0">${icon}</div>
                        <div class="text-sm font-medium">${this.escapeHTML(message)}</div>
                    `;
                    
                    this.toastContainer.appendChild(toast);
                    lucide.createIcons(); // NEW: Render toast icon

                    setTimeout(() => {
                        toast.classList.add('animate-fadeOut');
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);
                },

                // --- NEW: Column Count Functions ---
                loadAndApplyColumnCount() {
                    const savedCount = localStorage.getItem('tymrColumnCount') || 2;
                    this.columnCount = parseInt(savedCount, 10);
                    this.columnCountSelect.value = this.columnCount;
                    this.applyColumnClasses(this.columnCount);
                },

                setColumnCount(count) {
                    this.columnCount = parseInt(count, 10);
                    localStorage.setItem('tymrColumnCount', this.columnCount);
                    this.applyColumnClasses(this.columnCount);
                    // Re-render to fix empty state colspan if visible
                    if (this.dates.length === 0) {
                        this.renderAllDates();
                    }
                },

                applyColumnClasses(count) {
                    const container = this.countdownContainer;
                    // Remove all possible column classes first
                    container.classList.remove('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');

                    // Add classes based on selection
                    switch (count) {
                        case 1: 
                            // 'grid-cols-1' is already the base class
                            break;
                        case 2: 
                            container.classList.add('md:grid-cols-2'); 
                            break;
                        case 3: 
                            container.classList.add('md:grid-cols-2', 'lg:grid-cols-3'); 
                            break;
                        case 4: 
                            container.classList.add('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4'); 
                            break;
                    }
                },
                
                getColumnColspanClasses(count) {
                    switch (count) {
                        case 1: return '';
                        case 2: return 'md:col-span-2';
                        case 3: return 'md:col-span-2 lg:col-span-3';
                        case 4: return 'md:col-span-2 lg:col-span-3 xl:col-span-4';
                        default: return 'md:col-span-2';
                    }
                },
                // --- END: Column Count Functions ---


                // UPDATED: Major rewrite for new grouped structure and SortableJS
                renderAllDates() {
                    // Stop all existing timers
                    this.timers.forEach(timer => clearInterval(timer));
                    this.timers = [];
                    
                    // Destroy old Sortable instances
                    if (this.sortableGroups) this.sortableGroups.destroy();
                    this.sortableCards.forEach(s => s.destroy());
                    this.sortableCards = [];
                    
                    this.countdownContainer.innerHTML = '';

                    if (this.dates.length === 0) {
                        // NEW: Get dynamic colspan classes for empty state
                        const colspanClasses = this.getColumnColspanClasses(this.columnCount);
                        this.countdownContainer.innerHTML = `
                            <div data-empty-state class="${colspanClasses} text-center text-muted mt-12 w-full">
                                <i data-lucide="calendar-days" class="w-16 h-16 mx-auto mb-4" stroke-width="1.5"></i>
                                <h3 class="text-xl font-semibold text-primary">No Dates Yet</h3>
                                <p class="text-muted">Click "Add Date" to get started.</p>
                            </div>
                        `;
                        return;
                    }

                    // 1. Group goals
                    const groupedDates = this.dates.reduce((acc, date) => {
                        const groupName = date.group || 'General';
                        if (!acc[groupName]) {
                            acc[groupName] = [];
                        }
                        acc[groupName].push(date);
                        return acc;
                    }, {});

                    // 2. Sort goals within each group by date
                    for (const groupName in groupedDates) {
                        groupedDates[groupName].sort((a, b) => new Date(a.date) - new Date(b.date));
                    }

                    // 3. Determine group order
                    const allGroupNames = Object.keys(groupedDates);
                    // Filter out any ordered groups that no longer exist
                    let sortedGroupNames = this.groupOrder.filter(name => allGroupNames.includes(name));
                    // Add any new groups (not in the saved order) to the end
                    allGroupNames.forEach(name => {
                        if (!sortedGroupNames.includes(name)) {
                            sortedGroupNames.push(name);
                        }
                    });
                    // Ensure 'General' is last if it's new, but respect saved order otherwise
                    if (!this.groupOrder.includes('General') && sortedGroupNames.includes('General')) {
                        sortedGroupNames = sortedGroupNames.filter(name => name !== 'General');
                        sortedGroupNames.push('General');
                    }
                    // Save the cleaned/updated group order
                    this.groupOrder = sortedGroupNames;
                    this.saveGroupOrderData();


                    // 4. Render DOM
                    for (const groupName of sortedGroupNames) {
                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'group-container w-full';
                        groupContainer.dataset.groupName = groupName;

                        const groupHeader = document.createElement('h2');
                        groupHeader.className = 'group-header text-xl font-semibold text-primary w-full mb-3 mt-5 border-b border-color pb-2 flex items-center gap-2';
                        groupHeader.innerHTML = `
                            <i data-lucide="grip-vertical" class="w-4 h-4 text-muted shrink-0"></i>
                            ${this.escapeHTML(groupName)}
                        `;
                        
                        const cardList = document.createElement('div');
                        cardList.className = 'card-list';

                        for (const date of groupedDates[groupName]) {
                            const card = this.createDateCard(date);
                            cardList.appendChild(card);
                        }
                        
                        groupContainer.appendChild(groupHeader);
                        groupContainer.appendChild(cardList);
                        this.countdownContainer.appendChild(groupContainer);
                    }
                    
                    this.initSortable(); // NEW
                    this.startTimers(); // MOVED
                    lucide.createIcons(); // NEW: Render all card icons
                },

                // NEW: Initialize all SortableJS instances
                initSortable() {
                    // 1. Sort Groups
                    this.sortableGroups = new Sortable(this.countdownContainer, {
                        animation: 150,
                        handle: '.group-header', // Drag only by the header
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        onEnd: (evt) => this.handleGroupDrop(evt)
                    });

                    // 2. Sort Cards
                    const cardLists = this.countdownContainer.querySelectorAll('.card-list');
                    cardLists.forEach(list => {
                        const sortableList = new Sortable(list, {
                            animation: 150,
                            group: 'goals', // Allows dragging between lists
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: (evt) => this.handleCardDrop(evt)
                        });
                        this.sortableCards.push(sortableList);
                    });
                },

                // NEW: Handle card drop event
                handleCardDrop(evt) {
                    const dateId = evt.item.dataset.id;
                    const newGroupEl = evt.to.closest('.group-container');
                    if (!newGroupEl) return; // Should not happen

                    const newGroupName = newGroupEl.dataset.groupName;
                    
                    const date = this.dates.find(g => g.id === dateId);
                    if (date && date.group !== newGroupName) {
                        date.group = newGroupName;
                        this.saveDatesData(); // Save data, but do not re-render
                    }
                },

                // NEW: Handle group drop event
                handleGroupDrop(evt) {
                    const newOrder = Array.from(this.countdownContainer.children)
                        .map(el => el.dataset.groupName)
                        .filter(Boolean); // Filter out any undefined
                    
                    this.groupOrder = newOrder;
                    this.saveGroupOrderData(); // Save new order, do not re-render
                },

                // DELETED: getIconSVG function
                // (Removed lines 2011-2073)

                // NEW: ADDED HELPER FUNCTION
                calculateNextBirthday(dobString) {
                    try {
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // 00:00 today
                        const birthDate = new Date(dobString);
                        
                        // Handle invalid date string from input
                        if (isNaN(birthDate.getTime())) throw new Error('Invalid date');

                        const birthMonth = birthDate.getMonth();
                        const birthDay = birthDate.getDate();
                        const birthYear = birthDate.getFullYear();
                        const currentYear = now.getFullYear();

                        // Set birthday for this year
                        let nextBirthdayDate = new Date(currentYear, birthMonth, birthDay); // 00:00 this year
                        let nextAge = currentYear - birthYear;
                        let currentAge = nextAge;

                        // If this year's birthday date is *before* today's date, set for next year
                        if (nextBirthdayDate < today) {
                            nextBirthdayDate.setFullYear(currentYear + 1);
                            nextAge = nextBirthdayDate.getFullYear() - birthYear;
                        } else {
                            // If birthday is later this year, current age is one less
                            currentAge = nextAge - 1;
                        }
                        
                        // Handle case where birthday is today
                        if (nextBirthdayDate.getTime() === today.getTime()) {
                            currentAge = nextAge;
                        }

                        return { 
                            nextBirthdayDate: nextBirthdayDate, 
                            nextAge: nextAge, // The age they will be turning
                            currentAge: currentAge // The age they are right now
                        };
                    
                    } catch (e) {
                        console.error("Error calculating birthday:", e, dobString);
                        // Return a fallback to prevent crashes
                        return { nextBirthdayDate: new Date(), nextAge: 0, currentAge: 0 };
                    }
                },

                // NEW: Helper function to calculate next anniversary
                calculateNextAnniversary(anniversaryDateString) {
                    try {
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // 00:00 today
                        const anniversaryDate = new Date(anniversaryDateString);
                        
                        // Handle invalid date string from input
                        if (isNaN(anniversaryDate.getTime())) throw new Error('Invalid date');

                        const annivMonth = anniversaryDate.getMonth();
                        const annivDay = anniversaryDate.getDate();
                        const annivYear = anniversaryDate.getFullYear();
                        const currentYear = now.getFullYear();

                        // Set anniversary for this year
                        let nextAnniversaryDate = new Date(currentYear, annivMonth, annivDay); // 00:00 this year
                        let nextAnniversaryNumber = currentYear - annivYear;

                        // If this year's anniversary date is *before* today's date, set for next year
                        if (nextAnniversaryDate < today) {
                            nextAnniversaryDate.setFullYear(currentYear + 1);
                            nextAnniversaryNumber = nextAnniversaryDate.getFullYear() - annivYear;
                        }

                        return { 
                            nextAnniversaryDate: nextAnniversaryDate, 
                            nextAnniversaryNumber: nextAnniversaryNumber // The number it will be (e.g., 5th)
                        };
                    
                    } catch (e) {
                        console.error("Error calculating anniversary:", e, anniversaryDateString);
                        // Return a fallback to prevent crashes
                        return { nextAnniversaryDate: new Date(), nextAnniversaryNumber: 0 };
                    }
                },

                createDateCard(dateData) {
                    // REVERTED: Card element uses class
                    const card = document.createElement('div');
                    card.className = 'card-bg p-2.5 rounded-lg shadow-lg flex flex-col space-y-2 w-40'; 
                    card.dataset.id = dateData.id;
                    // REVERTED: Removed inline styles for bg and CSS vars

                    
                    // --- NEW Birthday & Anniversary Logic ---
                    let targetDate, formattedDate, timerDateString, nextAge = 0, currentAge = 0, nextAnniversaryNumber = 0; // UPDATED
                    const categoryLower = dateData.category.trim().toLowerCase();
                    let isBirthday = categoryLower === 'birthday';
                    let isAnniversary = categoryLower === 'anniversary';
                    
                    if (isBirthday && dateData.date) {
                        const bdayInfo = this.calculateNextBirthday(dateData.date);
                        targetDate = bdayInfo.nextBirthdayDate;
                        timerDateString = targetDate.toISOString();
                        const originalBirthdate = new Date(dateData.date);
                        formattedDate = originalBirthdate.toLocaleDateString(undefined, {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        nextAge = bdayInfo.nextAge; // UPDATED
                        currentAge = bdayInfo.currentAge; // UPDATED
                    } else if (isAnniversary && dateData.date) { // NEW: Anniversary logic
                        const annivInfo = this.calculateNextAnniversary(dateData.date);
                        targetDate = annivInfo.nextAnniversaryDate;
                        timerDateString = targetDate.toISOString();
                        const originalAnnivDate = new Date(dateData.date);
                        formattedDate = originalAnnivDate.toLocaleDateString(undefined, {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        nextAnniversaryNumber = annivInfo.nextAnniversaryNumber;
                    } else {
                        isBirthday = false; // Ensure it's false if date is missing
                        isAnniversary = false; // NEW
                        targetDate = new Date(dateData.date);
                        timerDateString = dateData.date;
                        formattedDate = targetDate.toLocaleDateString(undefined, {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                    }
                    // --- END Birthday Logic ---
                    
                    const totalMilestones = dateData.milestones?.length || 0;
                    const completedMilestones = dateData.milestones?.filter(m => m.completed).length || 0;
                    
                    const milestoneDots = (totalMilestones > 0 ?
                        [...Array(totalMilestones)].map((_, i) => 
                            `<div class="w-1.5 h-1.5 rounded-full ${i < completedMilestones ? 'bg-accent-light' : 'bg-interactive'}"></div>`
                        ).join('') :
                        '<div class="w-1.5 h-1.5 rounded-full opacity-0"></div>'
                    );

                    const isComplete = dateData.status === 'Completed';
                    const completeClass = isComplete ? 'opacity-60' : '';
                    const completeIconClass = isComplete ? 'text-success' : 'text-muted-light';

                    // UPDATED: Get colors
                    const categoryBGColor = this.escapeHTML(dateData.categoryColor || '#374151'); // hex for contrast calc
                    const tagBGColor = this.escapeHTML(dateData.categoryColor || 'var(--bg-interactive)'); // css value for style
                    const categoryTextColor = this.getContrastingTextColor(categoryBGColor);
                    const iconColor = this.escapeHTML(dateData.categoryColor || 'var(--text-muted)');
                    
                    // UPDATED: Use Lucide data attributes instead of inline SVG
                    let lucideIconName = this.escapeHTML(dateData.iconName?.trim().toLowerCase());
                    if (!lucideIconName) {
                        if (isBirthday) {
                            lucideIconName = 'cake';
                        } else if (isAnniversary) {
                            lucideIconName = 'gift';
                        } else {
                            // Fallback for general categories if no icon is specified
                            const categoryName = dateData.category.trim().toLowerCase();
                            const categoryIconMap = {
                                'work': 'briefcase',
                                'personal': 'user',
                                'health': 'heart',
                                'learn': 'graduation-cap',
                                'finance': 'dollar-sign',
                                'travel': 'globe-2',
                                'home': 'home'
                            };
                            lucideIconName = categoryIconMap[categoryName] || 'flag'; // Default to 'flag'
                        }
                    }
                    const iconSVG = `<i data-lucide="${lucideIconName}" class="w-3.5 h-3.5 shrink-0" style="stroke: ${iconColor};"></i>`;

                    // NEW: Conditionally render date or birthday/anniversary message
                    let dateOrSpecialMessageHTML = '';
                    if (isBirthday) {
                        // Show the birthday message placeholder INSTEAD of the date
                        dateOrSpecialMessageHTML = `
                            <div class="flex items-center gap-1.5 text-accent-light ${completeClass}">
                                <i data-lucide="cake" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs font-medium" data-birthday-message></span> <!-- New placeholder location -->
                            </div>
                        `;
                    } else if (isAnniversary) { // NEW: Anniversary message
                        dateOrSpecialMessageHTML = `
                            <div class="flex items-center gap-1.5 text-accent-light ${completeClass}">
                                <i data-lucide="gift" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs font-medium" data-anniversary-message></span> <!-- New placeholder location -->
                            </div>
                        `;
                    } else {
                        // Show the date as normal
                        dateOrSpecialMessageHTML = `
                            <div class="flex items-center gap-1.5 text-muted ${completeClass}">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs">${formattedDate}</span>
                            </div>
                        `;
                    }
                    
                    // NEW: Milestone section HTML
                    const isSpecialDate = isBirthday || isAnniversary; // NEW
                    const milestoneHTML = `
                        <div class="pt-0.5 ${completeClass}">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-muted">Milestones</span>
                                <span class="text-xs font-medium text-color">${completedMilestones} / ${totalMilestones}</span>
                            </div>
                            <div class="flex items-center gap-1 mt-1.5 h-1.5">
                                ${milestoneDots}
                            </div>
                        </div>
                    `;

                    card.innerHTML = `
                        <div class="flex items-start justify-between gap-1.5 ${completeClass}">
                            <div class="flex-col min-w-0"> <!-- Changed to flex-col -->
                                <div class="flex items-center gap-1.5 min-w-0"> <!-- Original title row -->
                                    ${iconSVG}
                                    <h3 class="text-sm font-semibold text-primary truncate" title="${this.escapeHTML(dateData.title)}">${this.escapeHTML(dateData.title)}</h3>
                                </div>
                                <!-- DELETED: Birthday message placeholder was here -->
                            </div>
                            <div class="shrink-0 rounded-full ${isComplete ? 'bg-green-500' : 'border border-color-strong'} w-2.5 h-2.5 mt-0.5" title="Status: ${dateData.status}"></div>
                        </div>

                        <!-- DELETED: Placeholder for birthday message was here -->

                        <!-- NEW: Show Date or Birthday "Turning X in" message -->
                        ${dateOrSpecialMessageHTML}
                        
                        <!-- NEW: Milestone section HTML -->
                        <!-- UPDATED: Show checklist/milestones for birthdays as well -->
                        <div class="pt-0.5 ${completeClass}">
                            <div class="flex items-center justify-between">
                                <!-- UPDATED: Show "Checklist" for special dates, "Milestones" otherwise -->
                                <span class="text-xs text-muted">${isSpecialDate ? 'Checklist' : 'Milestones'}</span>
                                <span class="text-xs font-medium text-color">${completedMilestones} / ${totalMilestones}</span>
                            </div>
                            <div class="flex items-center gap-1 mt-1.5 h-1.5">
                                ${milestoneDots}
                            </div>
                        </div> <!-- UPDATED -->

                        <!-- REVERTED: Timer elements use theme classes -->
                        <!-- UPDATED: data-age renamed to data-next-age -->
                        <!-- UPDATED: Added relative class -->
                        <div class="relative flex justify-between gap-0.5 text-center ${completeClass}" data-date="${timerDateString}" data-id="${dateData.id}" data-time-container 
                             data-is-birthday="${isBirthday}" 
                             data-is-anniversary="${isAnniversary}" 
                             data-next-age="${nextAge}" 
                             data-next-anniversary-number="${nextAnniversaryNumber}">
                            <div class="bg-interactive py-1 px-1 rounded w-auto min-w-[1.75rem]" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-days>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Days</span>
                            </div>
                            <div class="bg-interactive py-1 px-1 rounded w-7" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-hours>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Hrs</span>
                            </div>
                            <div class="bg-interactive py-1 px-1 rounded w-7" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-minutes>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Min</span>
                            </div>
                            <div class="bg-interactive py-1 px-1 rounded w-7" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-seconds>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Sec</span>
                            </div>
                            
                            <!-- UPDATED: This is now just for non-birthday alerts (and likely won't be used, but keep for safety) -->
                            <span class="absolute inset-0 flex items-center justify-center text-xs font-medium text-accent-light p-1 hidden" data-milestone-alert></span>
                        </div>
                        
                        <!-- This div is now for non-birthday alerts -->
                        <div class="text-center" data-non-birthday-alert-container>
                            <!-- Non-birthday alerts will go here -->
                        </div>

                        <!-- UPDATED: Bottom bar with priority dot REMOVED and category tag colored -->
                        <div class="flex items-center justify-between pt-1 border-t border-color min-w-0">
                            <div class="min-w-0"> 
                                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[0.65rem] font-medium ${completeClass} truncate" 
                                      style="background-color: ${tagBGColor}; color: ${categoryTextColor};" 
                                      title="Category: ${this.escapeHTML(dateData.category)}">
                                    ${this.escapeHTML(dateData.category) || 'Misc'}
                                </span>
                            </div>
                            <div class="flex items-center gap-0.5 shrink-0">
                                <button class="complete-card p-1 text-muted-light hover-text-success rounded ${completeIconClass}" title="Toggle Complete">
                                    <i data-lucide="check" class="w-3.5 h-3.5"></i>
                                </button>
                                <button class="edit-card p-1 text-muted-light hover-text-accent-light rounded" title="Edit">
                                    <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                                </button>
                                <button class="delete-card p-1 text-muted-light hover-text-danger rounded" title="Delete">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    return card;
                },

                startTimers() {
                    const timerElements = this.countdownContainer.querySelectorAll('[data-date]');
                    timerElements.forEach(el => {
                        const timerId = setInterval(() => {
                            this.updateTimer(el);
                        }, 1000);
                        this.timers.push(timerId);
                        this.updateTimer(el); // Initial call
                    });
                },

                updateTimer(el) {
                    const targetDate = new Date(el.dataset.date).getTime();
                    const now = new Date().getTime();
                    const distance = targetDate - now;

                    // NEW: Get birthday & anniversary data
                    const isBirthday = el.dataset.isBirthday === 'true';
                    const isAnniversary = el.dataset.isAnniversary === 'true';
                    const nextAge = el.dataset.nextAge; // UPDATED from data-age
                    const nextAnniversaryNumber = el.dataset.nextAnniversaryNumber;

                    const daysEl = el.querySelector('[data-days]');
                    const hoursEl = el.querySelector('[data-hours]');
                    const minutesEl = el.querySelector('[data-minutes]');
                    const secondsEl = el.querySelector('[data-seconds]');
                    
                    // UPDATED: Selectors
                    // FIX: Use .card-bg to select the *parent* card, not the timer element itself.
                    const birthdayMessageEl = el.closest('.card-bg[data-id]').querySelector('[data-birthday-message]'); // FIXED
                    const anniversaryMessageEl = el.closest('.card-bg[data-id]').querySelector('[data-anniversary-message]'); // NEW
                    const alertEl = el.querySelector('[data-milestone-alert]'); // Overlay alert (for non-birthday)
                    const nonBirthdayAlertContainer = el.closest('.card-bg[data-id]').querySelector('[data-non-birthday-alert-container]'); // FIXED
                    const timeContainer = el;
                    const timerSegments = el.querySelectorAll('[data-timer-segment]'); // NEW


                    if (distance < 0) {
                        const daysAgo = Math.floor(Math.abs(distance) / (1000 * 60 * 60 * 24));
                        let pastMessage;
                        
                        // NEW: Birthday & Anniversary logic for past dates
                        if (isBirthday) {
                            const absDist = Math.abs(distance);
                            if (absDist < (1000 * 60 * 60 * 24)) { // Birthday is *today*
                                pastMessage = `Happy ${this.getOrdinal(nextAge)} Birthday!`; // UPDATED
                            } else { // Birthday was yesterday or earlier
                                pastMessage = `Birthday passed (Turned ${nextAge})`;
                            }
                        } else if (isAnniversary) { // NEW
                            const absDist = Math.abs(distance);
                            if (absDist < (1000 * 60 * 60 * 24)) { // Anniversary is *today*
                                pastMessage = `Happy ${this.getOrdinal(nextAnniversaryNumber)} Anniversary!`;
                            } else { // Anniversary was yesterday or earlier
                                pastMessage = `Anniversary passed (${this.getOrdinal(nextAnniversaryNumber)})`;
                            }
                        } else if (daysAgo === 0) {
                            pastMessage = "Today!";
                        } else if (daysAgo === 1) {
                            pastMessage = "1 day ago";
                        } else {
                            pastMessage = `${daysAgo} days ago`;
                        }
                        
                        if (timeContainer) {
                            timeContainer.innerHTML = `<div class="text-xs text-center ${isBirthday || isAnniversary ? 'font-bold text-accent-light' : 'text-muted'} py-1 px-1 w-full">${pastMessage}</div>`;
                        }
                        // Clear alerts
                        if (birthdayMessageEl) birthdayMessageEl.innerHTML = ''; // NEW
                        if (anniversaryMessageEl) anniversaryMessageEl.innerHTML = ''; // NEW
                        if (nonBirthdayAlertContainer) nonBirthdayAlertContainer.innerHTML = '';
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    if (daysEl) daysEl.textContent = days;
                    if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
                    if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
                    if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');
                    
                    // UPDATED: Replaced single fragile 'if' with robust individual checks
                    if (isBirthday) {
                        // SHOW birthday message in its dedicated slot
                        if (birthdayMessageEl) {
                            // UPDATED: Changed text content as requested
                            birthdayMessageEl.textContent = `Turning ${nextAge} in`;
                        }
                        if (anniversaryMessageEl) anniversaryMessageEl.textContent = ''; // NEW: Clear other special
                        
                        // HIDE other alerts
                        if (alertEl) alertEl.classList.add('hidden'); 
                        if (nonBirthdayAlertContainer) nonBirthdayAlertContainer.innerHTML = ''; 

                        // SHOW timer segments
                        if (timerSegments) timerSegments.forEach(seg => seg.style.visibility = 'visible');
                    } else if (isAnniversary) { // NEW: Handle Anniversary
                        // SHOW anniversary message
                        if (anniversaryMessageEl) {
                            anniversaryMessageEl.textContent = `${this.getOrdinal(nextAnniversaryNumber)} Anniversary in`;
                        }
                        if (birthdayMessageEl) birthdayMessageEl.textContent = ''; // NEW: Clear other special

                        // HIDE other alerts
                        if (alertEl) alertEl.classList.add('hidden'); 
                        if (nonBirthdayAlertContainer) nonBirthdayAlertContainer.innerHTML = ''; 

                        // SHOW timer segments
                        if (timerSegments) timerSegments.forEach(seg => seg.style.visibility = 'visible');
                    } else {
                        // HIDE birthday message
                        if (birthdayMessageEl) birthdayMessageEl.textContent = '';
                        // HIDE anniversary message
                        if (anniversaryMessageEl) anniversaryMessageEl.textContent = ''; // NEW
                        
                        // HIDE overlay
                        if (alertEl) {
                            alertEl.textContent = ''; 
                            alertEl.classList.add('hidden'); 
                        }

                        // SHOW timer segments
                        if (timerSegments) timerSegments.forEach(seg => seg.style.visibility = 'visible');

                        // Put non-birthday alert in its own container
                        if (nonBirthdayAlertContainer) {
                            // UPDATED: Removed the milestone alert text as requested
                            nonBirthdayAlertContainer.innerHTML = ''; // WAS: `<span class="text-xs font-medium text-accent-light">${this.getMilestoneAlert(distance, days)}</span>`;
                        }
                    }
                },
                
                // NEW: Helper function for ordinals (1st, 2nd, 3rd)
                getOrdinal(n) {
                    if (n === null || n === undefined) return '';
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                },

                getMilestoneAlert(distance, days) {
                    const totalYears = Math.floor(days / 365.25);
                    const totalMonths = Math.floor(days / 30.44);

                    if (days <= 6) {
                        return "Less than a week left";
                    } else if (days === 7) {
                        return "1 week left!";
                    } else if (days <= 13) {
                        return "Less than 2 weeks left";
                    } else if (days === 14) {
                        return "2 weeks left!";
                    } else if (days < 30) {
                        return "Less than a month left";
                    } else if (totalMonths < 12) {
                        return totalMonths === 1 ? "1 month left" : `${totalMonths} months left`;
                    } else if (totalYears < 2) {
                        return "1 year left";
                    } else {
                        const remainingMonths = Math.floor((days % 365.25) / 30.44);
                        if (remainingMonths > 0) {
                            return `${totalYears} years & ${remainingMonths} ${remainingMonths === 1 ? 'month' : 'months'} left`;
                        } else {
                            return `${totalYears} years left`;
                        }
                    }
                },

                updateDatalists() {
                    const categories = [...new Set(this.dates.map(g => g.category).filter(Boolean))];
                    const groups = [...new Set(this.dates.map(g => g.group).filter(Boolean))];

                    this.categorySuggestions.innerHTML = categories.map(c => `<option value="${this.escapeHTML(c)}"></option>`).join('');
                    this.groupSuggestions.innerHTML = groups.map(g => `<option value="${this.escapeHTML(g)}"></option>`).join('');
                },
                
                escapeHTML(str) {
                    if (str === null || str === undefined) {
                        return '';
                    }
                    return str.toString()
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                },

                // NEW: ADDED HELPER FUNCTION
                getContrastingTextColor(hexColor) {
                    if (!hexColor) return 'var(--text-primary)';
                    // Remove the hash at the start if it exists
                    hexColor = hexColor.replace(/^#/, '');
                    // Parse r, g, b values
                    let r, g, b;
                    if (hexColor.length === 3) {
                        r = parseInt(hexColor.substring(0, 1) + hexColor.substring(0, 1), 16);
                        g = parseInt(hexColor.substring(1, 2) + hexColor.substring(1, 2), 16);
                        b = parseInt(hexColor.substring(2, 3) + hexColor.substring(2, 3), 16);
                    } else if (hexColor.length === 6) {
                        r = parseInt(hexColor.substring(0, 2), 16);
                        g = parseInt(hexColor.substring(2, 4), 16);
                        b = parseInt(hexColor.substring(4, 6), 16);
                    } else {
                        // Fallback for invalid color (e.g., css var)
                        return 'var(--text-primary)';
                    }
                    // Calculate luminance (per WCAG formula)
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    // Return black or white based on luminance
                    return luminance > 0.5 ? '#000000' : '#FFFFFF';
                },

                // --- End of App Object ---
            }; // <-- End of app object

            app.init(); // Initialize the app

        }); // <-- End of DOMContentLoaded listener
    </script>

</body>
</html>
