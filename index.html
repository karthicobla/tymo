<!DOCTYPE html>
<html lang="en" data-theme="dark"> <!-- Default theme -->
<head>
    <meta charset="UTF-R8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tymo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SortableJS library for drag-and-drop (Switched CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <!-- Popper.js for positioning the onboarding tour steps -->
    <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <!-- NEW: Lucide Icons Library -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <style>
        :root { /* Default: Dark Theme */
            --bg-main: #111827;
            --bg-card: #1f2937;
            --bg-modal: #1f2937; /* Use card bg for modal */
            --bg-interactive: #374151;
            --bg-interactive-deep: #111827;
            --bg-interactive-hover: #4b5563;
            --bg-accent: #2563eb;
            --bg-accent-hover: #1d4ed8;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-color: #d1d5db;
            --text-muted: #9ca3af;
            --text-muted-light: #6b7280;
            --text-on-accent: #ffffff;
            --border-color: #374151;
            --border-color-strong: #4b5563;
            --accent-color: #3b82f6;
            --accent-color-light: #60a5fa;
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-scheme: dark;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }

        html[data-theme="light"] {
            --bg-main: #f3f4f6;
            --bg-card: #ffffff;
            --bg-modal: #ffffff;
            --bg-interactive: #e5e7eb;
            --bg-interactive-deep: #f9fafb; /* Lighter column bg */
            --bg-interactive-hover: #d1d5db;
            --bg-accent: #2563eb;
            --bg-accent-hover: #1d4ed8;
            --text-primary: #111827;
            --text-secondary: #1f2937;
            --text-color: #374151;
            --text-muted: #6b7280;
            --text-muted-light: #9ca3af;
            --text-on-accent: #ffffff;
            --border-color: #e5e7eb;
            --border-color-strong: #d1d5db;
            --accent-color: #2563eb;
            --accent-color-light: #3b82f6;
            --color-success: #16a34a;
            --color-danger: #dc2626;
            --color-danger-hover: #b91c1c;
            --color-scheme: light;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }

        html[data-theme="forest"] {
            --bg-main: #1a2e27;
            --bg-card: #2a403a;
            --bg-modal: #2a403a;
            --bg-interactive: #3a594f;
            --bg-interactive-deep: #1f3a31; /* Darker column bg */
            --bg-interactive-hover: #4c7365;
            --bg-accent: #34d399;
            --bg-accent-hover: #10b981;
            --text-primary: #f0fdf4;
            --text-secondary: #d1fae5;
            --text-color: #a7f3d0;
            --text-muted: #6ee7b7;
            --text-muted-light: #34d399;
            --text-on-accent: #064e3b;
            --border-color: #3a594f;
            --border-color-strong: #4c7365;
            --accent-color: #34d399;
            --accent-color-light: #6ee7b7;
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-scheme: dark;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }

        html[data-theme="slate"] {
            --bg-main: #262626; /* neutral-800 */
            --bg-card: #404040; /* neutral-700 */
            --bg-modal: #404040;
            --bg-interactive: #525252; /* neutral-600 */
            --bg-interactive-deep: #171717; /* neutral-900 */
            --bg-interactive-hover: #737373; /* neutral-500 */
            --bg-accent: #a3a3a3; /* neutral-400 */
            --bg-accent-hover: #d4d4d4; /* neutral-300 */
            --text-primary: #f5f5f5; /* neutral-100 */
            --text-secondary: #e5e5e5; /* neutral-200 */
            --text-color: #d4d4d4; /* neutral-300 */
            --text-muted: #a3a3a3; /* neutral-400 */
            --text-muted-light: #737373; /* neutral-500 */
            --text-on-accent: #171717; /* neutral-900 */
            --border-color: #525252; /* neutral-600 */
            --border-color-strong: #737373; /* neutral-500 */
            --accent-color: #a3a3a3; /* neutral-400 */
            --accent-color-light: #d4d4d4; /* neutral-300 */
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-scheme: dark;
            --body-bg-image: none;
            --modal-backdrop-filter: none;
            --card-backdrop-filter: none;
        }


        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s, background-image 0.3s;
            background-color: var(--bg-main);
            color: var(--text-color);
            background-image: var(--body-bg-image);
            background-size: cover;
            background-attachment: fixed;
        }

        /* --- Semantic Color Classes --- */
        .body-bg { background-color: var(--bg-main); }
        .text-color { color: var(--text-color); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-muted-light { color: var(--text-muted-light); }
        .text-on-accent { color: var(--text-on-accent); }
        
        .card-bg { 
            background-color: var(--bg-card); 
            backdrop-filter: var(--card-backdrop-filter);
            -webkit-backdrop-filter: var(--card-backdrop-filter);
            transition: background-color 0.3s;
        }
        .modal-bg { 
            background-color: var(--bg-modal); 
            backdrop-filter: var(--modal-backdrop-filter);
            -webkit-backdrop-filter: var(--modal-backdrop-filter);
            transition: background-color 0.3s;
        }
        .input-bg { background-color: var(--bg-interactive); color: var(--text-primary); }
        .input-bg:focus {
            --tw-ring-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .select-bg {
            background-color: var(--bg-interactive); 
            color: var(--text-primary);
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .bg-interactive { background-color: var(--bg-interactive); }
        .bg-interactive-deep { background-color: var(--bg-interactive-deep); }
        .column-bg { background-color: var(--bg-interactive-deep); }

        .border-color { border-color: var(--border-color); }
        .border-color-strong { border-color: var(--border-color-strong); }

        .btn {
            transition: background-color 0.2s, color 0.2s;
        }
        .btn-primary {
            background-color: var(--bg-accent);
            color: var(--text-on-accent);
        }
        .btn-primary:hover {
            background-color: var(--bg-accent-hover);
        }
        .btn-secondary {
            background-color: var(--bg-interactive);
            color: var(--text-secondary);
        }
        .btn-secondary:hover {
            background-color: var(--bg-interactive-hover);
        }
        .btn-danger-text {
            color: var(--color-danger);
        }
        .btn-danger-text:hover {
            color: var(--color-danger-hover);
        }
        .btn-danger-solid {
            background-color: var(--color-danger);
            color: var(--text-on-accent);
        }
        .btn-danger-solid:hover {
            background-color: var(--color-danger-hover);
        }
        .btn-neutral {
            background-color: var(--bg-interactive);
            color: var(--text-color);
        }
        .btn-neutral:hover {
            background-color: var(--bg-interactive-hover);
        }
        .text-accent-light { color: var(--accent-color-light); }
        /* NEW: Added class for milestone dots and glow effect */
        .bg-accent-light {
            background-color: var(--accent-color-light);
            box-shadow: 0 0 4px var(--accent-color-light);
        }
        .text-accent { color: var(--accent-color); }
        .hover-text-accent:hover { color: var(--accent-color); }
        .text-success { color: var(--color-success); }
        .text-danger { color: var(--color-danger); }
        .hover-text-success:hover { color: var(--color-success); }
        .hover-text-accent-light:hover { color: var(--accent-color-light); }
        .hover-text-danger:hover { color: var(--color-danger); }
        
        input[type="datetime-local"] {
            color-scheme: var(--color-scheme);
        }

        /* Modify color input style */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 2.5rem; /* 40px */
            padding: 0.25rem; /* p-1 */
            border-width: 1px;
            border-color: var(--border-color-strong);
            background-color: var(--bg-interactive);
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
            border-radius: 0.375rem; /* rounded-md */
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 0.375rem; /* rounded-md */
        }
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 0.375rem; /* rounded-md */
        }
        
        .theme-btn {
            transition: all 0.2s;
            color: var(--text-muted); /* Default icon color */
        }
        .theme-btn:hover {
            color: var(--text-primary); /* Hover icon color */
            background-color: var(--bg-interactive-hover);
        }
        .theme-btn.active-theme {
            background-color: var(--accent-color);
            color: var(--text-on-accent);
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* For horizontal scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-interactive-deep);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--text-muted-light);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        .modal {
            display: none;
        }
        .modal.flex {
            display: flex;
        }

        /* --- Toast Animations --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }
        .animate-fadeOut {
            animation: fadeOut 0.5s ease-in forwards;
        }

        /* --- SortableJS Styles --- */
        .group-container {
            width: 100%; /* Ensure groups stack vertically */
        }
        .card-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 0.75rem; /* 12px */
            min-height: 50px; /* Drop area for empty groups */
        }
        .group-header {
            cursor: grab;
            user-select: none;
        }
        .group-header:active {
            cursor: grabbing;
        }
        /* Ghost class for dragged item */
        .sortable-ghost {
            opacity: 0.4;
            background: var(--bg-interactive);
        }
        .sortable-drag {
            opacity: 0.95;
            transform: rotate(2deg);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.15);
        }

        /* --- Onboarding Styles --- */
        .onboarding-highlight {
            position: relative;
            z-index: 195 !important; /* Above overlay, below step */
            transition: all 0.3s ease;
            box-shadow: 0 0 0 4px var(--accent-color), 0 0 20px 10px var(--accent-color);
            border-radius: 8px; /* Match element rounding */
        }
        /* Make sure pseudo-elements don't block the highlight */
        .onboarding-highlight::before,
        .onboarding-highlight::after {
            z-index: -1;
        }

        #onboardingArrow,
        #onboardingArrow::before {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--bg-modal);
        }
        #onboardingArrow {
            visibility: hidden;
        }
        #onboardingArrow::before {
            visibility: visible;
            content: '';
            transform: rotate(45deg);
        }
        
        /* Popper placement styling */
        #onboardingStep[data-popper-placement^='top'] > #onboardingArrow {
            bottom: -4px;
        }
        #onboardingStep[data-popper-placement^='bottom'] > #onboardingArrow {
            top: -4px;
        }
        #onboardingStep[data-popper-placement^='left'] > #onboardingArrow {
            right: -4px;
        }
        #onboardingStep[data-popper-placement^='right'] > #onboardingArrow {
            left: -4px;
        }
        /* --- END: Onboarding Styles --- */

        /* --- NEW: Profile Popover Styles --- */
        .popover {
            display: none;
            position: absolute;
            z-index: 50;
            top: 100%;
            right: 0;
            margin-top: 0.5rem; /* mt-2 */
            width: 14rem; /* w-56 */
            transform-origin: top right;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-width: 1px;
        }
        .popover.flex {
            display: flex;
            flex-direction: column;
        }
        .profile-list-item {
            transition: background-color 0.15s ease-in-out;
        }
        .profile-list-item:hover {
            background-color: var(--bg-interactive);
        }
    </style>
</head>
<body class="antialiased body-bg text-color">

    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-6 flex items-center justify-between">
            <h1 class="text-6xl font-bold text-primary">tymo</h1>
            
            <div id="themeSwitcher" class="flex items-center gap-1 bg-interactive-deep p-1 rounded-lg">
                <button class="theme-btn p-1 rounded-md" data-theme="dark" title="Dark Theme">
                    <i data-lucide="moon" width="20" height="20"></i>
                </button>
                <button class="theme-btn p-1 rounded-md" data-theme="light" title="Light Theme">
                    <i data-lucide="sun" width="20" height="20"></i>
                </button>
                <button class="theme-btn p-1 rounded-md" data-theme="forest" title="Forest Theme">
                    <i data-lucide="trees" width="20" height="20"></i>
                </button>
                <button class="theme-btn p-1 rounded-md" data-theme="slate" title="Slate Theme">
                    <i data-lucide="layout-grid" width="20" height="20"></i>
                </button>
            </div>

            <div class="flex items-center gap-2">
                <button id="addDateBtn" class="btn btn-primary font-medium py-2 px-4 rounded-lg text-sm flex items-center gap-1.5">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Add Date
                </button>
                
                <!-- NEW: Profile Switcher -->
                <div id="profileContainer" class="relative">
                    <button id="profileBtn" class="btn btn-secondary font-medium py-2 px-4 rounded-lg text-sm flex items-center gap-1.5 w-full">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        <span id="currentProfileName" class="truncate max-w-[100px]">Profile</span>
                        <i data-lucide="chevrons-up-down" class="w-4 h-4 text-muted-light"></i>
                    </button>
                    <!-- Profile Popover -->
                    <div id="profilePopover" class="popover modal-bg border-color">
                        <div class="p-2 border-b border-color">
                            <span class="text-xs font-medium text-muted">PROFILES</span>
                        </div>
                        <div id="profileList" class="py-1 max-h-48 overflow-y-auto">
                            <!-- Profile items injected by JS -->
                        </div>
                        <div class="p-2 border-t border-color space-y-2">
                            <input type="text" id="newProfileName" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2 text-sm focus:ring-2 outline-none" placeholder="Create new profile...">
                            <button id="addProfileBtn" class="btn btn-primary w-full text-sm py-2">
                                Add Profile
                            </button>
                        </div>
                    </div>
                </div>
                <!-- END: Profile Switcher -->

                <button id="settingsBtn" class="btn btn-secondary font-medium p-2 rounded-lg text-sm">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                <button id="helpBtn" class="btn btn-secondary font-medium p-2 rounded-lg text-sm" title="Show Help">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Countdown Container -->
        <div id="countdownContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
            <!-- Widgets and groups will be dynamically inserted here -->
        </div>
    </div>

    <!-- Add/Edit Date Modal -->
    <div id="dateModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="modal-bg rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-color">
                <h2 id="modalTitle" class="text-lg font-semibold text-primary">Add New Date</h2>
                <button id="closeModalBtn" class="text-muted hover:text-primary">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto space-y-6">
                <input type="hidden" id="dateId">

                <!-- Date Title -->
                <div>
                    <label for="dateTitle" class="block text-sm font-medium text-color mb-1.5">Date Title</label>
                    <input type="text" id="dateTitle" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., Launch Project Orion">
                </div>

                <!-- Notes / Description -->
                <div>
                    <label for="dateNotes" class="block text-sm font-medium text-color mb-1.5">Notes / Description</label>
                    <textarea id="dateNotes" rows="3" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="Add more details about this goal..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Target Date -->
                    <div>
                        <label for="dateTarget" class="block text-sm font-medium text-color mb-1.5">Target Date & Time</label>
                        <input type="datetime-local" id="dateTarget" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none">
                    </div>

                    <!-- Category -->
                    <div>
                        <label for="goalCategory" class="block text-sm font-medium text-color mb-1.5">Category</label>
                        <input type="text" id="dateCategory" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., Personal, Work" list="categorySuggestions">
                        <datalist id="categorySuggestions">
                            <!-- Dynamically populated. Add common suggestions. -->
                            <option value="Personal"></option>
                            <option value="Work"></option>
                            <option value="Birthday"></option>
                            <option value="Anniversary"></option>
                            <option value="Health"></option>
                            <option value="Finance"></option>
                            <option value="Learn"></option>
                            <option value="Travel"></option>
                            <option value="Home"></option>
                        </datalist>
                    </div>

                    <!-- Remembrance Checkbox -->
                    <div id="remembranceCheckboxContainer" class="hidden md:col-span-1 flex items-end pb-2.5">
                        <div class="flex items-center">
                            <input id="isRemembrance" type="checkbox" class="h-4 w-4 rounded border-color-strong bg-interactive text-accent-light focus:ring-accent-light">
                            <label for="isRemembrance" class="ml-2 block text-sm font-medium text-color">In Remembrance</label>
                        </div>
                    </div>
        
                    <!-- Date of Death -->
                    <div id="dateOfDeathContainer" class="hidden md:col-span-1">
                        <label for="dateOfDeath" class="block text-sm font-medium text-color mb-1.5">Date of Passing</label>
                        <input type="date" id="dateOfDeath" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none">
                    </div>
                    
                    <!-- Icon Name -->
                    <div>
                        <label for="dateIconName" class="block text-sm font-medium text-color mb-1.5">Icon Name (from lucide.dev)</label>
                        <input type="text" id="dateIconName" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., rocket, award" list="iconSuggestions">
                        <datalist id="iconSuggestions">
                            <!-- Common icon suggestions (truncated for brevity) -->
                            <option value="rocket"></option>
                            <option value="award"></option>
                            <option value="book-open"></option>
                            <option value="briefcase"></option>
                            <option value="calendar"></option>
                            <option value="cake"></option>
                            <option value-"gift"></option>
                            <option value="calendar-heart"></option>
                            <option value="heart"></option>
                            <option value="home"></option>
                            <option value="flag"></option>
                            <option value="graduation-cap"></option>
                            <option value="dollar-sign"></option>
                            <option value="globe-2"></option>
                            <option value="user"></option>
                            <option value="star"></option>
                            <option value="target"></option>
                            <option value="trending-up"></option>
                        </datalist>
                    </div>

                    <!-- Group -->
                    <div>
                        <label for="dateGroup" class="block text-sm font-medium text-color mb-1.5">Group</label>
                        <input type="text" id="dateGroup" class="input-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="e.g., Q4 Projects" list="groupSuggestions">
                        <datalist id="groupSuggestions">
                            <!-- Dynamically populated -->
                        </datalist>
                    </div>

                    <!-- Category Color -->
                    <div>
                        <label for="dateCategoryColor" class="block text-sm font-medium text-color mb-1.5">Icon & Category Color</label>
                        <input type="color" id="dateCategoryColor" value="#374151"> <!-- Default value -->
                    </div>
                </div>

                <!-- Milestones (Subtasks) -->
                <div id="milestoneSection">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-color">Key Results (Milestones)</h3>
                        <div class="flex items-center">
                            <input id="dateShowMilestones" type="checkbox" class="h-4 w-4 rounded border-color-strong bg-interactive text-accent-light focus:ring-accent-light">
                            <label for="dateShowMilestones" class="ml-2 block text-sm font-medium text-color">Show on Card</label>
                        </div>
                    </div>
                    <div id="milestonesContainer" class="space-y-2">
                        <!-- Milestones will be dynamically inserted here -->
                    </div>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="text" id="newMilestoneInput" class="input-bg flex-1 border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none" placeholder="Add a new milestone...">
                        <button id="addMilestoneBtn" type="button" class="btn btn-secondary p-2.5 rounded-lg text-accent-light hover:text-accent">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-4 bg-interactive-deep bg-opacity-50 border-t border-color rounded-b-xl">
                <button id="deleteDateBtn" type="button" class="btn-danger-text font-medium text-sm px-3 py-2 rounded-lg">Delete Date</button>
                <div>
                    <button id="cancelModalBtn" type="button" class="btn btn-neutral font-medium rounded-lg text-sm px-5 py-2.5 mr-2">Cancel</button>
                    <button id="saveDateBtn" type="button" class="btn btn-primary font-medium rounded-lg text-sm px-5 py-2.5">Save Date</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="modal-bg rounded-xl shadow-2xl w-full max-w-md">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-color">
                <h2 class="text-lg font-semibold text-primary">Settings</h2>
                <button id="closeSettingsBtn" class="text-muted hover:text-primary">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-6 space-y-4">
                <!-- Column Count Setting -->
                <div>
                    <label for="columnCountSelect" class="block text-sm font-medium text-color mb-1.5">Columns on Wide Screen</label>
                    <select id="columnCountSelect" class="select-bg w-full border border-color-strong rounded-lg px-3 py-2.5 text-sm focus:ring-2 outline-none">
                        <option value="1">1 Column</option>
                        <option value="2">2 Columns (Default)</option>
                        <option value="3">3 Columns</option>
                        <option value="4">4 Columns</option>
                    </select>
                </div>
                <!-- Data Management -->
                <p class="text-sm text-muted pt-2">Export *all* your profiles and data as a single backup file, or import a file to restore your entire application.</p>
                <button id="exportDataBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg text-sm flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Export All Data (.json)
                </button>
                <div>
                    <label for="importFile" class="btn btn-primary w-full font-medium py-2.5 px-4 rounded-lg text-sm flex items-center justify-center gap-2 cursor-pointer">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        Import All Data (.json)
                    </label>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal fixed inset-0 z-[100] items-center justify-center bg-black bg-opacity-75 p-4">
        <div class="modal-bg rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
                <h3 id="confirmTitle" class="text-lg font-semibold text-primary">Are you sure?</h3>
                <p id="confirmMessage" class="mt-2 text-sm text-muted">This action cannot be undone.</p>
            </div>
            <div class="flex justify-end gap-3 p-4 bg-interactive-deep bg-opacity-50 rounded-b-xl border-t border-color">
                <button id="confirmCancel" class="btn btn-neutral font-medium rounded-lg text-sm px-4 py-2">Cancel</button>
                <button id="confirmDelete" class="btn btn-danger-solid font-medium rounded-lg text-sm px-4 py-2">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-[200] w-full max-w-xs space-y-3">
        <!-- Toasts will be dynamically inserted here -->
    </div>

    <!-- Onboarding Tour -->
    <div id="onboardingOverlay" class="modal fixed inset-0 z-[190] bg-black bg-opacity-75"></div>
    <div id="onboardingStep" class="modal absolute z-[200] modal-bg rounded-lg shadow-xl w-full max-w-xs p-4 flex flex-col" data-step-index="0">
        <div id="onboardingText" class="text-sm text-color mb-4">Welcome to Tymo!</div>
        <div class="flex items-center justify-between">
            <button id="onboardingSkip" class="text-sm text-muted hover:text-primary px-3 py-1.5 rounded-lg">Skip</button>
            <div class="flex gap-3">
                <button id="onboardingPrev" class="btn btn-neutral text-sm px-3 py-1.5">Prev</button>
                <button id="onboardingNext" class="btn btn-primary text-sm px-3 py-1.5">Next</button>
            </div>
        </div>
        <!-- Arrow element for pointing -->
        <div id="onboardingArrow" data-popper-arrow></div>
    </div>


    <script>
        // Wrap everything in a DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // UI Elements
                countdownContainer: document.getElementById('countdownContainer'),
                addDateBtn: document.getElementById('addDateBtn'),
                settingsBtn: document.getElementById('settingsBtn'),
                themeSwitcher: document.getElementById('themeSwitcher'),
                helpBtn: document.getElementById('helpBtn'),

                // NEW: Profile UI
                profileContainer: document.getElementById('profileContainer'),
                profileBtn: document.getElementById('profileBtn'),
                currentProfileName: document.getElementById('currentProfileName'),
                profilePopover: document.getElementById('profilePopover'),
                profileList: document.getElementById('profileList'),
                newProfileName: document.getElementById('newProfileName'),
                addProfileBtn: document.getElementById('addProfileBtn'),

                // Goal Modal
                dateModal: document.getElementById('dateModal'),
                modalTitle: document.getElementById('modalTitle'),
                closeModalBtn: document.getElementById('closeModalBtn'),
                cancelModalBtn: document.getElementById('cancelModalBtn'),
                saveDateBtn: document.getElementById('saveDateBtn'),
                deleteDateBtn: document.getElementById('deleteDateBtn'),
                dateId: document.getElementById('dateId'),
                dateTitle: document.getElementById('dateTitle'),
                dateNotes: document.getElementById('dateNotes'),
                dateTarget: document.getElementById('dateTarget'),
                dateCategory: document.getElementById('dateCategory'),
                dateCategoryColor: document.getElementById('dateCategoryColor'),
                dateIconName: document.getElementById('dateIconName'),
                dateGroup: document.getElementById('dateGroup'),
                categorySuggestions: document.getElementById('categorySuggestions'),
                groupSuggestions: document.getElementById('groupSuggestions'),

                // Remembrance Fields
                remembranceCheckboxContainer: document.getElementById('remembranceCheckboxContainer'),
                isRemembrance: document.getElementById('isRemembrance'),
                dateOfDeathContainer: document.getElementById('dateOfDeathContainer'),
                dateOfDeath: document.getElementById('dateOfDeath'),

                // Milestones
                milestonesContainer: document.getElementById('milestonesContainer'),
                newMilestoneInput: document.getElementById('newMilestoneInput'),
                addMilestoneBtn: document.getElementById('addMilestoneBtn'),
                milestoneSection: document.getElementById('milestoneSection'),
                dateShowMilestones: document.getElementById('dateShowMilestones'),

                // Settings Modal
                settingsModal: document.getElementById('settingsModal'),
                closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                exportDataBtn: document.getElementById('exportDataBtn'),
                importFile: document.getElementById('importFile'),
                columnCountSelect: document.getElementById('columnCountSelect'),
                // exportProfileName: document.getElementById('exportProfileName'), // REMOVED

                // Confirm Modal
                confirmModal: document.getElementById('confirmModal'),
                confirmTitle: document.getElementById('confirmTitle'),
                confirmMessage: document.getElementById('confirmMessage'),
                confirmCancel: document.getElementById('confirmCancel'),
                confirmDelete: document.getElementById('confirmDelete'),
                
                // Toast
                toastContainer: document.getElementById('toastContainer'),

                // Onboarding
                onboardingOverlay: document.getElementById('onboardingOverlay'),
                onboardingStep: document.getElementById('onboardingStep'),
                onboardingText: document.getElementById('onboardingText'),
                onboardingSkip: document.getElementById('onboardingSkip'),
                onboardingPrev: document.getElementById('onboardingPrev'),
                onboardingNext: document.getElementById('onboardingNext'),
                onboardingArrow: document.getElementById('onboardingArrow'),

                // App State
                appState: {}, // NEW: Main state object
                currentProfileId: null, // NEW
                timers: [],
                currentMilestones: [],
                _confirmCallback: null,
                sortableGroups: null,
                sortableCards: [],
                // columnCount: 2, // REMOVED: Now part of profile settings

                // Onboarding State
                tourSteps: [],
                currentTourStep: 0,
                popperInstance: null,

                // --- NEW: App State Getters ---
                // These functions get data for the *current* profile
                ensureProfileData() {
                    if (!this.appState.profileData[this.currentProfileId]) {
                        console.warn("Ensuring profile data for", this.currentProfileId);
                        this.appState.profileData[this.currentProfileId] = {
                            dates: [],
                            groupOrder: [],
                            settings: this.getDefaultSettings()
                        };
                    }
                    // Ensure settings object exists as well
                    if (!this.appState.profileData[this.currentProfileId].settings) {
                         this.appState.profileData[this.currentProfileId].settings = this.getDefaultSettings();
                    }
                    // Ensure dates array exists
                    if (!this.appState.profileData[this.currentProfileId].dates) {
                         this.appState.profileData[this.currentProfileId].dates = [];
                    }
                    // Ensure groupOrder array exists
                    if (!this.appState.profileData[this.currentProfileId].groupOrder) {
                         this.appState.profileData[this.currentProfileId].groupOrder = [];
                    }
                    
                    return this.appState.profileData[this.currentProfileId];
                },

                getDates() {
                    // return this.appState.profileData[this.currentProfileId]?.dates || [];
                    return this.ensureProfileData().dates;
                },
                getGroupOrder() {
                    // return this.appState.profileData[this.currentProfileId]?.groupOrder || [];
                    return this.ensureProfileData().groupOrder;
                },
                getSettings() {
                    // return this.appState.profileData[this.currentProfileId]?.settings || this.getDefaultSettings();
                    return this.ensureProfileData().settings;
                },
                getCurrentProfile() {
                    return this.appState.profiles[this.currentProfileId] || null;
                },
                getCurrentData() {
                    return this.appState.profileData[this.currentProfileId] || null;
                },
                getDefaultSettings() {
                    return {
                        theme: 'dark',
                        columnCount: 2,
                        hasSeenTour: false
                    };
                },
                
                // NEW: Demo Data Generator
                getDemoDates() {
                    // Use a fixed "today" for consistent demo data
                    const today = new Date('2025-10-29T18:30:00'); 
                    
                    const addDays = (date, days) => {
                        const newDate = new Date(date);
                        newDate.setDate(newDate.getDate() + days);
                        return newDate.toISOString().substring(0, 16); // 'YYYY-MM-DDTHH:mm'
                    };
                    
                    const addMonths = (date, months) => {
                        const newDate = new Date(date);
                        newDate.setMonth(newDate.getMonth() + months);
                        return newDate.toISOString().substring(0, 16);
                    };
                    
                    const addYears = (date, years) => {
                        const newDate = new Date(date);
                        newDate.setFullYear(newDate.getFullYear() + years);
                        return newDate.toISOString().substring(0, 16);
                    };

                    return [
                        {
                            id: 'demo_project_1',
                            title: 'Project Phoenix Launch',
                            notes: 'Final push for the new platform launch.',
                            date: addMonths(today, 2), // ~2 months from now
                            category: 'Work',
                            categoryColor: '#f97316', // Orange
                            iconName: 'rocket',
                            group: 'Projects',
                            milestones: [
                                { id: 'ms_demo_1', text: 'Finalize UI', completed: true },
                                { id: 'ms_demo_2', text: 'Deploy to Staging', completed: true },
                                { id: 'ms_demo_3', text: 'Run final QA', completed: false },
                                { id: 'ms_demo_4', text: 'Go-Live!', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_birthday_1',
                            title: 'My Birthday',
                            notes: 'Time to celebrate!',
                            date: '1990-11-15', // DOB
                            category: 'Birthday',
                            categoryColor: '#ec4899', // Pink
                            iconName: 'cake',
                            group: 'Personal',
                            milestones: [
                                { id: 'ms_demo_5', text: 'Send out invites', completed: true },
                                { id: 'ms_demo_6', text: 'Order cake', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_travel_1',
                            title: 'Trip to Japan',
                            notes: 'Cherry blossom season!',
                            date: '2026-04-10T09:00', // Far future
                            category: 'Travel',
                            categoryColor: '#14b8a6', // Teal
                            iconName: 'globe-2',
                            group: 'Travel',
                            milestones: [
                                { id: 'ms_demo_7', text: 'Book flights', completed: false },
                                { id: 'ms_demo_8', text: 'Book hotels', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_anniv_1',
                            title: 'Work Anniversary',
                            notes: 'Started at Tymo Inc.',
                            date: '2022-03-01', // Anniversary date
                            category: 'Anniversary',
                            categoryColor: '#6366f1', // Indigo
                            iconName: 'award',
                            group: 'Work',
                            milestones: [
                                { id: 'ms_demo_25', text: 'Demo Milestone 1', completed: false },
                                { id: 'ms_demo_26', text: 'Demo Milestone 2', completed: true }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_remembrance_1',
                            title: 'Grandma',
                            notes: 'Always in our hearts.',
                            date: '1940-07-10', // DOB
                            category: 'Birthday',
                            categoryColor: '#a855f7', // Purple
                            iconName: 'flower-2',
                            group: 'Personal',
                            milestones: [],
                            status: 'Pending',
                            showMilestones: false,
                            isRemembrance: true,
                            dateOfDeath: '2021-05-20', // DOD
                        },
                        {
                            id: 'demo_completed_1',
                            title: 'Q3 Report',
                            notes: 'Submitted to management.',
                            date: '2025-09-30T17:00', // In the past
                            category: 'Work',
                            categoryColor: '#84cc16', // Lime
                            iconName: 'check-square',
                            group: 'Work',
                            milestones: [
                                { id: 'ms_demo_9', text: 'Gather data', completed: true },
                                { id: 'ms_demo_10', text: 'Submit draft', completed: true }
                            ],
                            status: 'Completed', // <-- This is key
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        // --- NEW DEMO ITEMS ---
                        {
                            id: 'demo_fitness_1',
                            title: 'Run a 10k',
                            notes: 'Training for the city marathon.',
                            date: addMonths(today, 3), // ~3 months from now
                            category: 'Health',
                            categoryColor: '#22c55e', // Green
                            iconName: 'activity',
                            group: 'Personal',
                            milestones: [
                                { id: 'ms_demo_11', text: 'Run 5k', completed: true },
                                { id: 'ms_demo_12', text: 'Run 7k', completed: false },
                                { id: 'ms_demo_13', text: 'Register for race', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_learn_1',
                            title: 'Complete JS Course',
                            notes: 'Finish the advanced JavaScript module.',
                            date: addDays(today, 45), // 1.5 months
                            category: 'Learn',
                            categoryColor: '#3b82f6', // Blue
                            iconName: 'graduation-cap',
                            group: 'Personal',
                            milestones: [
                                { id: 'ms_demo_14', text: 'Async/Await', completed: true },
                                { id: 'ms_demo_15', text: 'Data Structures', completed: true },
                                { id: 'ms_demo_16', text: 'Final Project', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_finance_1',
                            title: 'House Deposit Goal',
                            notes: 'Target $50,000.',
                            date: addYears(today, 3), // 3 years from now
                            category: 'Finance',
                            categoryColor: '#10b981', // Emerald
                            iconName: 'piggy-bank',
                            group: 'Finance',
                            milestones: [
                                { id: 'ms_demo_17', text: '$10k', completed: true },
                                { id: 'ms_demo_18', text: '$25k', completed: true },
                                { id: 'ms_demo_19', text: '$40k', completed: false },
                                { id: 'ms_demo_20', text: '$50k!', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_read_1',
                            title: 'Finish "Dune"',
                            notes: 'The spice must flow...',
                            date: addDays(today, 10), // 10 days
                            category: 'Personal',
                            categoryColor: '#a855f7', // Purple
                            iconName: 'book-open',
                            group: 'Personal',
                            milestones: [],
                            status: 'Pending',
                            showMilestones: false,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_travel_2',
                            title: 'Camping',
                            notes: 'At Big Bear Lake.',
                            date: addDays(today, 3), // This weekend!
                            category: 'Travel',
                            categoryColor: '#14b8a6', // Teal
                            iconName: 'tent',
                            group: 'Travel',
                            milestones: [
                                { id: 'ms_demo_21', text: 'Buy supplies', completed: false },
                                { id: 'ms_demo_22', text: 'Pack car', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        },
                        {
                            id: 'demo_work_2',
                            title: 'Q4 Session',
                            notes: 'Summary for the board.',
                            date: addDays(today, 20), // ~3 weeks
                            category: 'Work',
                            categoryColor: '#f97316', // Orange
                            iconName: 'presentation',
                            group: 'Projects',
                            milestones: [
                                { id: 'ms_demo_23', text: 'Draft slides', completed: false },
                                { id: 'ms_demo_24', text: 'Review with team', completed: false }
                            ],
                            status: 'Pending',
                            showMilestones: true,
                            isRemembrance: false,
                            dateOfDeath: '',
                        }
                    ];
                },
                // --- END: App State Getters ---

                init() {
                    // This function is now guaranteed to run after Sortable and lucide are defined
                    // because of the `defer` attribute on the script tags.
                    this.loadAppState(); // NEW: Single load function
                    this.loadProfileData(this.currentProfileId); // NEW: Load data for the active profile
                    
                    // REMOVED: loadTheme, loadDates, loadAndApplyColumnCount
                    
                    // renderAllDates and updateDatalists are called inside loadProfileData
                    this.attachEventListeners();
                    this.initThemes();
                    this.initTourSteps();
                    this.startTour();
                    lucide.createIcons();
                },

                attachEventListeners() {
                    this.addDateBtn.addEventListener('click', () => this.openModal());
                    this.settingsBtn.addEventListener('click', () => this.openSettings());
                    this.helpBtn.addEventListener('click', () => this.startTour(true));
                    
                    // NEW: Profile Listeners
                    this.profileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleProfilePopover();
                    });
                    this.addProfileBtn.addEventListener('click', () => this.addProfile());
                    this.newProfileName.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addProfile();
                        }
                    });
                    // Close popover on outside click
                    document.addEventListener('click', (e) => {
                        if (!this.profileContainer.contains(e.target)) {
                            this.profilePopover.classList.remove('flex');
                        }
                    });

                    // Goal Modal
                    this.closeModalBtn.addEventListener('click', () => this.closeModal());
                    this.cancelModalBtn.addEventListener('click', () => this.closeModal());
                    this.saveDateBtn.addEventListener('click', () => this.saveDate());
                    this.deleteDateBtn.addEventListener('click', () => this.handleDeleteDate());
                    this.dateCategory.addEventListener('input', () => this.updateModalForCategory());
                    this.isRemembrance.addEventListener('change', () => this.updateModalForCategory());

                    // Milestones
                    this.addMilestoneBtn.addEventListener('click', () => this.addMilestone());
                    this.newMilestoneInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addMilestone();
                        }
                    });
                    this.milestonesContainer.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-milestone')) {
                            const id = e.target.closest('.milestone-item').dataset.id;
                            this.deleteMilestone(id);
                        } else if (e.target.closest('.milestone-checkbox')) {
                            const id = e.target.closest('.milestone-item').dataset.id;
                            this.toggleMilestone(id);
                        }
                    });
                    
                    // Settings Modal
                    this.closeSettingsBtn.addEventListener('click', () => this.closeSettings());
                    this.exportDataBtn.addEventListener('click', () => this.exportData());
                    this.importFile.addEventListener('change', (e) => this.importData(e));
                    this.columnCountSelect.addEventListener('change', (e) => this.setColumnCount(e.target.value));

                    // Confirm Modal
                    this.confirmCancel.addEventListener('click', () => this.closeConfirm());
                    this.confirmDelete.addEventListener('click', () => this.runConfirm());

                    // Card actions
                    this.countdownContainer.addEventListener('click', (e) => {
                        const card = e.target.closest('[data-id]');
                        if (!card) return;
                        const id = card.dataset.id;
                        if (e.target.closest('.edit-card')) this.openModal(id);
                        else if (e.target.closest('.delete-card')) this.handleDeleteCard(id); // Fixed: Was calling a non-existent function
                        else if (e.target.closest('.complete-card')) this.toggleComplete(id);
                    });

                    // Onboarding
                    this.onboardingSkip.addEventListener('click', () => this.endTour());
                    this.onboardingNext.addEventListener('click', () => this.nextTourStep());
                    this.onboardingPrev.addEventListener('click', () => this.prevTourStep());
                },

                initThemes() {
                    this.themeSwitcher.addEventListener('click', (e) => {
                        const themeBtn = e.target.closest('.theme-btn');
                        if (themeBtn) {
                            this.setTheme(themeBtn.dataset.theme);
                        }
                    });
                },

                // UPDATED: Now part of profile settings
                loadTheme() {
                    const theme = this.getSettings().theme;
                    this.setTheme(theme, false); // false = don't save, just apply
                },

                // UPDATED: Now saves to profile
                setTheme(themeName, doSave = true) {
                    document.documentElement.dataset.theme = themeName;
                    
                    if (doSave) {
                        this.getSettings().theme = themeName;
                        this.saveAppState();
                    }

                    this.themeSwitcher.querySelectorAll('.theme-btn').forEach(btn => {
                        btn.classList.toggle('active-theme', btn.dataset.theme === themeName);
                    });
                },
                
                // REMOVED: loadDates()
                // REMOVED: saveDatesData()
                // REMOVED: saveGroupOrderData()

                // --- NEW: Profile & State Management ---
                loadAppState() {
                    const appData = localStorage.getItem('tymrApp');
                    if (appData) {
                        this.appState = JSON.parse(appData);
                        this.currentProfileId = this.appState.currentProfileId;
                        // Migration check for older data
                        if (!this.appState.profileData) {
                            this.migrateOldData();
                        }
                    } else {
                        // No data, create default
                        this.createDefaultProfileData();
                    }
                    
                    // Ensure a valid profile is always selected
                    if (!this.currentProfileId || !this.appState.profiles[this.currentProfileId]) {
                        this.currentProfileId = Object.keys(this.appState.profiles)[0];
                        this.appState.currentProfileId = this.currentProfileId;
                        this.saveAppState();
                    }
                },
                
                saveAppState() {
                    localStorage.setItem('tymrApp', JSON.stringify(this.appState));
                },
                
                createDefaultProfileData() {
                    const defaultProfileId = `profile_${Date.now()}`;
                    this.appState = {
                        currentProfileId: defaultProfileId,
                        profiles: {
                            [defaultProfileId]: { id: defaultProfileId, name: 'Demo Profile' } // MODIFIED
                        },
                        profileData: {
                            [defaultProfileId]: {
                                dates: this.getDemoDates(), // MODIFIED
                                groupOrder: ['Projects', 'Work', 'Personal', 'Travel', 'Finance'], // MODIFIED
                                settings: this.getDefaultSettings()
                            }
                        }
                    };
                    this.currentProfileId = defaultProfileId;
                    this.saveAppState();
                },
                
                // NEW: Handle migrating data from the old format
                migrateOldData() {
                    console.log("Migrating old data...");
                    const oldDates = JSON.parse(localStorage.getItem('countdownDates') || '[]');
                    const oldGroupOrder = JSON.parse(localStorage.getItem('tymrGroupOrder') || '[]');
                    const oldTheme = localStorage.getItem('tymrTheme') || 'dark';
                    const oldColumnCount = parseInt(localStorage.getItem('tymrColumnCount') || '2', 10);
                    const oldTourSeen = localStorage.getItem('tymrTourSeen') === 'true';

                    const defaultProfileId = `profile_${Date.now()}`;
                    this.appState = {
                        currentProfileId: defaultProfileId,
                        profiles: {
                            [defaultProfileId]: { id: defaultProfileId, name: 'Personal (Migrated)' }
                        },
                        profileData: {
                            [defaultProfileId]: {
                                dates: oldDates,
                                groupOrder: oldGroupOrder,
                                settings: {
                                    theme: oldTheme,
                                    columnCount: oldColumnCount,
                                    hasSeenTour: oldTourSeen
                                }
                            }
                        }
                    };
                    this.currentProfileId = defaultProfileId;
                    this.saveAppState();
                    
                    // Clean up old keys
                    localStorage.removeItem('countdownDates');
                    localStorage.removeItem('tymrGroupOrder');
                    localStorage.removeItem('tymrTheme');
                    localStorage.removeItem('tymrColumnCount');
                    localStorage.removeItem('tymrTourSeen');
                },

                // NEW: This is the main "switcher" function
                loadProfileData(profileId) {
                    if (!this.appState.profiles[profileId]) {
                        console.error("Profile not found:", profileId);
                        return;
                    }
                    
                    this.currentProfileId = profileId;
                    this.appState.currentProfileId = profileId;
                    this.saveAppState(); // Save the new active profile ID

                    const profile = this.getCurrentProfile();
                    const settings = this.getSettings();
                    
                    // 1. Update UI
                    this.currentProfileName.textContent = profile.name;
                    // this.exportProfileName.textContent = profile.name; // REMOVED
                    this.renderProfileList();
                    
                    // 2. Apply Settings
                    this.setTheme(settings.theme, false); // Apply, don't re-save
                    this.applyColumnClasses(settings.columnCount);
                    this.columnCountSelect.value = settings.columnCount;
                    
                    // 3. Render Data
                    this.renderAllDates(); // This now uses getDates() and getGroupOrder()
                    this.updateDatalists();
                },

                toggleProfilePopover() {
                    this.profilePopover.classList.toggle('flex');
                    if (this.profilePopover.classList.contains('flex')) {
                        this.renderProfileList();
                        lucide.createIcons();
                    }
                },
                
                renderProfileList() {
                    this.profileList.innerHTML = '';
                    const profiles = Object.values(this.appState.profiles);
                    
                    if (profiles.length === 0) {
                         this.profileList.innerHTML = '<span class="px-3 py-2 text-sm text-muted">No profiles.</span>';
                         return;
                    }
                    
                    profiles.sort((a, b) => (a.name || '').localeCompare(b.name || '')).forEach(profile => {
                        const isCurrent = profile.id === this.currentProfileId;
                        const item = document.createElement('div');
                        item.className = `profile-list-item flex items-center justify-between group ${isCurrent ? 'bg-interactive' : ''}`;
                        
                        const switchBtn = document.createElement('button');
                        switchBtn.className = 'flex-1 flex items-center gap-2 text-left px-3 py-2 text-sm text-secondary';
                        switchBtn.innerHTML = `
                            ${isCurrent ? '<i data-lucide="check" class="w-4 h-4 text-accent"></i>' : '<span class="w-4 h-4"></span>'}
                            <span class="truncate ${isCurrent ? 'font-semibold text-primary' : ''}">${this.escapeHTML(profile.name)}</span>
                        `;
                        switchBtn.onclick = () => {
                            this.loadProfileData(profile.id);
                            this.toggleProfilePopover();
                        };
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'p-2 text-muted-light hover:text-danger opacity-0 group-hover:opacity-100 transition-opacity';
                        deleteBtn.title = `Delete ${this.escapeHTML(profile.name)}`;
                        deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.handleDeleteProfile(profile.id);
                        };

                        item.appendChild(switchBtn);
                        // Don't allow deleting the last profile
                        if (profiles.length > 1) {
                            item.appendChild(deleteBtn);
                        }
                        this.profileList.appendChild(item);
                    });
                },
                
                addProfile() {
                    const name = this.newProfileName.value.trim();
                    if (!name) {
                        this.showToast("Please enter a profile name.", "error");
                        return;
                    }
                    
                    const newId = `profile_${Date.now()}`;
                    this.appState.profiles[newId] = { id: newId, name: name };
                    this.appState.profileData[newId] = {
                        dates: [],
                        groupOrder: [],
                        settings: this.getDefaultSettings()
                    };
                    
                    this.saveAppState();
                    this.loadProfileData(newId); // Switch to the new profile
                    this.newProfileName.value = '';
                    this.toggleProfilePopover();
                },

                handleDeleteProfile(profileId) {
                    if (Object.keys(this.appState.profiles).length <= 1) {
                        this.showToast("Cannot delete the last profile.", "error");
                        return;
                    }
                    
                    const profileName = this.appState.profiles[profileId].name;
                    this.showConfirm(
                        `Delete "${profileName}"?`,
                        `Are you sure? All dates and settings for this profile will be permanently lost.`,
                        () => {
                            delete this.appState.profiles[profileId];
                            delete this.appState.profileData[profileId];
                            
                            // If we deleted the active profile, switch to the first available one
                            if (this.currentProfileId === profileId) {
                                const newCurrentId = Object.keys(this.appState.profiles)[0];
                                this.loadProfileData(newCurrentId);
                            } else {
                                this.renderProfileList(); // Just re-render the list
                            }
                            this.saveAppState();
                            this.showToast(`Profile "${profileName}" deleted.`, 'success');
                        }
                    );
                },
                // --- END: Profile & State Management ---

                // UPDATED: Now part of saveAndRender()
                saveAndRender() {
                    // This function no longer saves directly,
                    // it just triggers the render.
                    // The actual save happens in saveDate(), setColumnCount(), etc.
                    this.renderAllDates();
                    this.updateDatalists();
                },

                openModal(id = null) {
                    this.resetModal();
                    if (id) {
                        const date = this.getDates().find(g => g.id === id); // UPDATED
                        if (date) {
                            this.modalTitle.textContent = 'Edit Date';
                            this.dateId.value = date.id;
                            this.dateTitle.value = date.title;
                            this.dateNotes.value = date.notes || '';
                            this.dateTarget.value = date.date ? date.date.substring(0, 16) : '';
                            this.dateCategory.value = date.category || '';
                            this.dateCategoryColor.value = date.categoryColor || '#374151';
                            this.dateIconName.value = date.iconName || '';
                            this.dateGroup.value = date.group || '';
                            this.currentMilestones = JSON.parse(JSON.stringify(date.milestones || []));
                            this.deleteDateBtn.style.display = 'block';

                            this.isRemembrance.checked = date.isRemembrance || false;
                            this.dateOfDeath.value = date.dateOfDeath || '';
                            this.dateShowMilestones.checked = date.showMilestones ?? true;
                        }
                    } else {
                        this.modalTitle.textContent = 'Add New Date';
                        this.deleteDateBtn.style.display = 'none';
                    }
                    this.renderMilestones();
                    this.updateModalForCategory();
                    this.dateModal.classList.add('flex');
                    lucide.createIcons();
                },

                closeModal() {
                    this.dateModal.classList.remove('flex');
                    this.resetModal();
                },

                resetModal() {
                    this.modalTitle.textContent = 'Add New Date';
                    this.dateId.value = '';
                    this.dateTitle.value = '';
                    this.dateNotes.value = '';
                    this.dateTarget.value = '';
                    this.dateCategory.value = '';
                    this.dateCategoryColor.value = '#374151';
                    this.dateIconName.value = '';
                    this.dateGroup.value = '';
                    this.currentMilestones = [];
                    this.milestonesContainer.innerHTML = '';
                    this.newMilestoneInput.value = '';
                    this.dateShowMilestones.checked = true;
                    this.remembranceCheckboxContainer.classList.add('hidden');
                    this.isRemembrance.checked = false;
                    this.dateOfDeathContainer.classList.add('hidden');
                    this.dateOfDeath.value = '';
                },

                updateModalForCategory() {
                    const categoryLabel = document.querySelector('label[for="dateTarget"]');
                    const categoryLower = this.dateCategory.value.trim().toLowerCase();
                    const isBirthday = categoryLower === 'birthday';
                    const isAnniversary = categoryLower === 'anniversary';
                    const isSpecialDate = isBirthday || isAnniversary;
                    const remembranceChecked = this.isRemembrance.checked;
                    
                    const milestoneTitle = this.milestoneSection.querySelector('h3');

                    this.milestoneSection.style.display = 'block';
                    if (isSpecialDate) {
                        if (milestoneTitle) milestoneTitle.textContent = 'Checklist';
                    } else {
                        if (milestoneTitle) milestoneTitle.textContent = 'Key Results (Milestones)';
                    }

                    if (isBirthday) {
                        this.remembranceCheckboxContainer.classList.remove('hidden');
                    } else {
                        this.remembranceCheckboxContainer.classList.add('hidden');
                    }
        
                    if (isBirthday && remembranceChecked) {
                        this.dateOfDeathContainer.classList.remove('hidden');
                    } else {
                        this.dateOfDeathContainer.classList.add('hidden');
                    }

                    if (isSpecialDate) {
                        if (isBirthday) {
                            categoryLabel.textContent = 'Birthday (Date of Birth)';
                        } else if (isAnniversary) {
                            categoryLabel.textContent = 'Anniversary Date';
                        }
                        this.dateTarget.type = 'date';
                        if (this.dateTarget.value.includes('T')) {
                            this.dateTarget.value = this.dateTarget.value.split('T')[0];
                        }
                    } else {
                        categoryLabel.textContent = 'Target Date & Time';
                        this.dateTarget.type = 'datetime-local';
                        if (this.dateTarget.value && !this.dateTarget.value.includes('T')) {
                            this.dateTarget.value = `${this.dateTarget.value}T12:00`;
                        }
                    }
                },

                saveDate() {
                    const id = this.dateId.value;
                    const title = this.dateTitle.value.trim();
                    const target = this.dateTarget.value;

                    if (!title || !target) {
                        this.showToast('Please fill in both Date Title and Target Date.', 'error');
                        return;
                    }
                    if (this.isRemembrance.checked && !this.dateOfDeath.value) {
                        this.showToast('Please add a Date of Passing for remembrance.', 'error');
                        return;
                    }

                    const dates = this.getDates(); // UPDATED
                    const existingDate = dates.find(g => g.id === id);

                    const dateData = {
                        title: title,
                        notes: this.dateNotes.value.trim(),
                        date: target,
                        category: this.dateCategory.value.trim(),
                        categoryColor: this.dateCategoryColor.value,
                        iconName: this.dateIconName.value.trim(),
                        group: this.dateGroup.value.trim() || 'General',
                        milestones: this.currentMilestones,
                        status: existingDate?.status || 'Pending',
                        showMilestones: this.dateShowMilestones.checked,
                        isRemembrance: this.isRemembrance.checked,
                        dateOfDeath: this.isRemembrance.checked ? this.dateOfDeath.value : '',
                    };

                    if (id) {
                        const index = dates.findIndex(g => g.id === id);
                        if (index !== -1) {
                            this.getDates()[index] = { ...dates[index], ...dateData }; // UPDATED
                        }
                    } else {
                        this.getDates().push({ // UPDATED
                            ...dateData,
                            id: `goal_${Date.now()}`
                        });
                    }

                    this.saveAppState(); // NEW
                    this.saveAndRender();
                    this.closeModal();
                },
                
                handleDeleteDate() {
                    const id = this.dateId.value;
                    if (!id) return;
                    
                    this.showConfirm(
                        'Delete Date?',
                        'Are you sure you want to delete this date? This action cannot be undone.',
                        () => {
                            // UPDATED
                            const dates = this.getDates();
                            const newDates = dates.filter(g => g.id !== id);
                            this.appState.profileData[this.currentProfileId].dates = newDates;
                            
                            this.saveAppState(); // NEW
                            this.saveAndRender();
                            this.closeModal();
                        }
                    );
                },

                // NEW: Added missing function for card delete button
                handleDeleteCard(id) {
                    if (!id) return;
                    const date = this.getDates().find(g => g.id === id);
                    if (!date) return;

                    this.showConfirm(
                        `Delete "${this.escapeHTML(date.title)}"?`,
                        'Are you sure you want to delete this date? This action cannot be undone.',
                        () => {
                            const dates = this.getDates();
                            const newDates = dates.filter(g => g.id !== id);
                            this.appState.profileData[this.currentProfileId].dates = newDates;
                            
                            this.saveAppState();
                            this.saveAndRender();
                            this.showToast('Date deleted.', 'success');
                        }
                    );
                },

                toggleComplete(id) {
                    const date = this.getDates().find(g => g.id === id); // UPDATED
                    if (date) {
                        date.status = date.status === 'Completed' ? 'Pending' : 'Completed';
                        this.saveAppState(); // NEW
                        this.saveAndRender();
                    }
                },

                renderMilestones() {
                    this.milestonesContainer.innerHTML = '';
                    if (this.currentMilestones.length === 0) {
                        this.milestonesContainer.innerHTML = '<p class="text-xs text-muted italic">No milestones added yet.</p>';
                        return;
                    }
                    this.currentMilestones.forEach(milestone => {
                        this.milestonesContainer.appendChild(this.createMilestoneElement(milestone));
                    });
                    lucide.createIcons(); // NEW: Render milestone icons
                },
                
                createMilestoneElement(milestone) {
                    const div = document.createElement('div');
                    div.className = 'milestone-item flex items-center justify-between bg-interactive p-2 rounded-md';
                    div.dataset.id = milestone.id;
                    
                    const checked = milestone.completed ? 'checked' : '';
                    const textClass = milestone.completed ? 'line-through text-muted-light' : 'text-secondary';

                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <input type="checkbox" ${checked} class="milestone-checkbox form-checkbox h-4 w-4 bg-interactive border-color-strong text-accent-light rounded focus:ring-accent-light focus:ring-offset-gray-800">
                            <span class="text-sm ${textClass}">${this.escapeHTML(milestone.text)}</span>
                        </div>
                        <button type="button" class="delete-milestone text-muted-light hover-text-danger p-1">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    `;
                    return div;
                },
                
                addMilestone() {
                    const text = this.newMilestoneInput.value.trim();
                    if (text) {
                        this.currentMilestones.push({
                            id: `ms_${Date.now()}`,
                            text: text,
                            completed: false
                        });
                        this.newMilestoneInput.value = '';
                        this.renderMilestones();
                    }
                },

                deleteMilestone(id) {
                    this.currentMilestones = this.currentMilestones.filter(ms => ms.id !== id);
                    this.renderMilestones();
                },
                
                toggleMilestone(id) {
                    const milestone = this.currentMilestones.find(ms => ms.id === id); // Fixed: Was !==
                    if (milestone) {
                        milestone.completed = !milestone.completed;
                        this.renderMilestones();
                    }
                },

                openSettings() {
                    this.settingsModal.classList.add('flex');
                    lucide.createIcons();
                },

                closeSettings() {
                    this.settingsModal.classList.remove('flex');
                },
                
                // UPDATED: Exports current profile data
                exportData() {
                    const currentData = this.getCurrentData(); // NEW
                    if (currentData.dates.length === 0) {
                        this.showToast('No dates in this profile to export.', 'error');
                        return;
                    }
                    // Export dates, groupOrder, and settings for this profile
                    const dataToExport = {
                        dates: currentData.dates,
                        groupOrder: currentData.groupOrder,
                        settings: currentData.settings
                    };
                    
                    const dataStr = JSON.stringify(dataToExport, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    const profileName = this.getCurrentProfile().name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    a.download = `tymr_${profileName}_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.closeSettings();
                },
                
                // UPDATED: Exports ALL app data
                exportData() {
                    if (!this.appState || !this.appState.profiles || Object.keys(this.appState.profiles).length === 0) {
                        this.showToast('No data to export.', 'error');
                        return;
                    }
                    
                    // Export the entire appState
                    const dataToExport = this.appState;
                    
                    const dataStr = JSON.stringify(dataToExport, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `tymr_all_data_${new Date().toISOString().split('T')[0]}.json`; // New filename
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.closeSettings();
                    this.showToast('All data exported successfully.', 'success');
                },
                
                // UPDATED: Imports ALL app data
                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            // Check for the new structure (the full appState)
                            if (importedData.currentProfileId && importedData.profiles && importedData.profileData) {
                                this.showConfirm(
                                    'Import All Data?',
                                    `This will overwrite *all* existing profiles, dates, and settings. This cannot be undone. Are you sure?`,
                                    () => {
                                        this.appState = importedData; // Overwrite entire state
                                        this.saveAppState();
                                        // Load the active profile from the *newly* imported data
                                        this.loadProfileData(this.appState.currentProfileId); 
                                        this.closeSettings();
                                        event.target.value = null; // Reset file input
                                        this.showToast('All data imported successfully.', 'success');
                                    }
                                );
                            } else {
                                this.showToast('Invalid file format. Expected full application data.', 'error');
                            }
                        } catch (err) {
                            console.error('Error importing data:', err);
                            this.showToast('Failed to read or parse file.', 'error');
                        }
                    };
                    reader.readAsText(file);
                },

                // --- Onboarding Tour Methods ---
                initTourSteps() {
                    this.tourSteps = [
                        {
                            selector: 'h1',
                            text: `
                                <div class='flex items-center gap-2 mb-3'>
                                    <span class='text-2xl font-bold text-primary'>Tymo — Count What Matters</span>
                                </div>
                                <p class='text-sm text-color mb-3 italic'>
                                    Time is always moving — quietly, constantly.<br>
                                    Tymo&nbsp;helps you stay connected to it.
                                </p>
                                <p class='text-sm text-color mb-3'>
                                    Not just a countdown app, but a living record of everything that deserves your attention.
                                    <br>Moments to come, memories to honor, milestones to anticipate.
                                </p>
                                <p class='text-sm text-color mb-2 font-medium'>
                                    Use it to track:
                                </p>
                                <ul class='list-none space-y-1.5 text-sm text-color mb-3'>
                                    <li class='flex items-start gap-2'>
                                        <i data-lucide='rocket' class='w-4 h-4 text-accent-light shrink-0 mt-0.5'></i>
                                        <span>Product launches & critical deadlines</span>
                                    </li>
                                    <li class='flex items-start gap-2'>
                                        <i data-lucide='plane' class='w-4 h-4 text-accent-light shrink-0 mt-0.5'></i>
                                        <span>Upcoming trips & vacations</span>
                                    </li>
                                    <li class='flex items-start gap-2'>
                                        <i data-lucide='cake' class='w-4 h-4 text-accent-light shrink-0 mt-0.5'></i>
                                        <span>Birthdays, anniversaries & events</span>
                                    </li>
                                    <li class='flex items-start gap-2'>
                                        <i data-lucide='target' class='w-4 h-4 text-accent-light shrink-0 mt-0.5'></i>
                                        <span>Personal goals & habits</span>
                                    </li>
                                </ul>
                                <p class='text-sm text-muted'>
                                    This is your demo dashboard. Once you’re onboarded, you can delete this and create your own profiles.
                                </p>
                            `,
                            placement: 'bottom-start'
                        },
                        // MODIFIED: Point to demo project
                        {
                            selector: '[data-id="demo_project_1"]',
                            text: "This is a countdown for a project. You can add milestones, notes, and an icon.",
                            placement: 'bottom',
                            fallbackSelector: '[data-id="demo_birthday_1"]',
                            fallbackText: "This is a countdown widget. You can add milestones, notes, and an icon."
                        },
                        // MODIFIED: Point to birthday
                        {
                            selector: '[data-id="demo_birthday_1"]',
                            text: "Tymo handles special dates, like birthdays and anniversaries, automatically.",
                            placement: 'bottom',
                            fallbackSelector: '[data-id="demo_remembrance_1"]',
                            fallbackText: "Tymo handles special dates, like birthdays and anniversaries."
                        },
                        // NEW: Point to remembrance
                        {
                            selector: '[data-id="demo_remembrance_1"]',
                            text: "It can also track remembrance dates to honor loved ones.",
                            placement: 'bottom',
                            fallbackSelector: '[data-id="demo_travel_1"]',
                            fallbackText: "It can also track special dates."
                        },
                        // NEW: Point to completed
                        {
                            selector: '[data-id="demo_completed_1"]',
                            text: "Completed items are grayed out, keeping your dashboard clean.",
                            placement: 'top',
                            fallbackSelector: '[data-id="demo_travel_1"]'
                        },
                        // NEW: Point to group header
                        {
                            selector: '[data-group-name="Projects"]',
                            text: "Drag groups or individual cards to re-order your dashboard.",
                            placement: 'bottom',
                            fallbackSelector: '#countdownContainer'
                        },
                        // MODIFIED: Updated text
                        {
                            selector: '#profileBtn',
                            text: "This is your profile switcher! Create separate profiles for 'Work', 'Home', etc.",
                            placement: 'bottom-end',
                            finalFallbackSelector: '#addDateBtn',
                            finalFallbackText: "Click 'Add Date' to create your own countdown!"
                        },
                        {
                            selector: '#addDateBtn',
                            text: "Click 'Add Date' to create your own countdowns in this profile!",
                            placement: 'bottom-end'
                        },
                        {
                            selector: '#themeSwitcher',
                            text: "Choose your favorite look. The theme is saved to your current profile.",
                            placement: 'bottom'
                        },
                        {
                            selector: '#settingsBtn',
                            text: "Here you can change column counts or export/import all your data.",
                            placement: 'bottom-end'
                        },
                        {
                            selector: '#helpBtn',
                            text: "You can restart this guide anytime by clicking this help icon.",
                            placement: 'bottom-end'
                        }
                    ];
                },

                startTour(force = false) {
                    const hasSeenTour = this.getSettings().hasSeenTour; // UPDATED
                    if (hasSeenTour && !force) {
                        this.endTour(false); // false = don't save
                        return;
                    }
                    this.showTourStep(0);
                },

                endTour(doSave = true) {
                    if (this.popperInstance) this.popperInstance.destroy();
                    document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight'));
                    
                    this.onboardingStep.classList.remove('flex');
                    this.onboardingOverlay.classList.remove('flex');
                    
                    if (doSave) {
                        this.getSettings().hasSeenTour = true; // UPDATED
                        this.saveAppState(); // NEW
                    }
                },

                showTourStep(index) {
                    if (this.popperInstance) this.popperInstance.destroy();
                    document.querySelectorAll('.onboarding-highlight').forEach(el => el.classList.remove('onboarding-highlight'));

                    if (index >= this.tourSteps.length) {
                        this.endTour();
                        return;
                    }

                    this.currentTourStep = index;
                    let step = this.tourSteps[index];
                    let targetElement = document.querySelector(step.selector);
                    let text = step.text;
                    let placement = step.placement;

                    // NEW: Added fallback logic
                    if (!targetElement && step.fallbackSelector) {
                        targetElement = document.querySelector(step.fallbackSelector);
                        if (targetElement) {
                            text = step.fallbackText || text;
                            placement = step.fallbackPlacement || placement;
                        }
                    }
                    if (!targetElement && step.finalFallbackSelector) {
                        targetElement = document.querySelector(step.finalFallbackSelector);
                        if (targetElement) {
                            text = step.finalFallbackText || text;
                            placement = step.finalFallbackPlacement || placement;
                        }
                    }
                    
                    // NEW: Adjust modal width
                    const stepElement = this.onboardingStep;
                    stepElement.classList.remove('max-w-xs', 'max-w-md');
                    if (index === 0) {
                        stepElement.classList.add('max-w-md'); // Wider for the intro text
                    } else {
                        stepElement.classList.add('max-w-xs'); // Default width
                    }
                    
                    this.onboardingText.innerHTML = text; // <-- CHANGED from textContent
                    lucide.createIcons(); // NEW: Render icons in tour step
                    this.onboardingStep.classList.add('flex');
                    this.onboardingOverlay.classList.add('flex');

                    if (targetElement) {
                        targetElement.classList.add('onboarding-highlight');
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

                        this.popperInstance = Popper.createPopper(targetElement, this.onboardingStep, {
                            placement: placement,
                            modifiers: [
                                { name: 'offset', options: { offset: [0, 12] } },
                                { name: 'arrow', options: { element: this.onboardingArrow } }
                            ]
                        });
                    } else {
                        this.onboardingStep.style.top = '50%';
                        this.onboardingStep.style.left = '50%';
                        this.onboardingStep.style.transform = 'translate(-50%, -50%)';
                    }

                    this.onboardingPrev.style.display = (index === 0) ? 'none' : 'block';
                    this.onboardingNext.textContent = (index === this.tourSteps.length - 1) ? 'Done' : 'Next';
                },

                nextTourStep() {
                    this.showTourStep(this.currentTourStep + 1);
                },

                prevTourStep() {
                    this.showTourStep(this.currentTourStep - 1);
                },
                // --- END: Onboarding Tour Methods ---

                showConfirm(title, message, callback) {
                    this.confirmTitle.textContent = title;
                    this.confirmMessage.textContent = message;
                    this._confirmCallback = callback;
                    this.confirmModal.classList.add('flex');
                    lucide.createIcons();
                },

                closeConfirm() {
                    this.confirmModal.classList.remove('flex');
                    this._confirmCallback = null;
                },

                runConfirm() {
                    if (this._confirmCallback) {
                        this._confirmCallback();
                    }
                    this.closeConfirm();
                },

                showToast(message, type = 'error') {
                    const toast = document.createElement('div');
                    let icon = '';
                    let classes = '';

                    if (type === 'error') {
                        classes = 'bg-red-600 text-white';
                        icon = `<i data-lucide="alert-circle" class="w-5 h-5"></i>`;
                    } else {
                        classes = 'bg-green-600 text-white';
                        icon = `<i data-lucide="check-circle" class="w-5 h-5"></i>`;
                    }

                    toast.className = `flex items-center gap-3 w-full p-4 rounded-lg shadow-lg ${classes}`;
                    toast.classList.add('animate-fadeIn');
                    toast.innerHTML = `
                        <div class="shrink-0">${icon}</div>
                        <div class="text-sm font-medium">${this.escapeHTML(message)}</div>
                    `;
                    
                    this.toastContainer.appendChild(toast);
                    lucide.createIcons();

                    setTimeout(() => {
                        toast.classList.add('animate-fadeOut');
                        setTimeout(() => toast.remove(), 500);
                    }, 3000);
                },

                // --- Column Count Functions ---
                // UPDATED: No longer loads, just applies
                loadAndApplyColumnCount() {
                    const columnCount = this.getSettings().columnCount; // UPDATED
                    this.columnCountSelect.value = columnCount;
                    this.applyColumnClasses(columnCount);
                },

                // UPDATED: Saves to profile
                setColumnCount(count) {
                    const columnCount = parseInt(count, 10); // UPDATED
                    this.getSettings().columnCount = columnCount; // UPDATED
                    this.saveAppState(); // NEW
                    this.applyColumnClasses(columnCount);
                    if (this.getDates().length === 0) { // UPDATED
                        this.renderAllDates();
                    }
                },

                applyColumnClasses(count) {
                    const container = this.countdownContainer;
                    container.classList.remove('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4');

                    switch (count) {
                        case 1: break;
                        case 2: container.classList.add('md:grid-cols-2'); break;
                        case 3: container.classList.add('md:grid-cols-2', 'lg:grid-cols-3'); break;
                        case 4: container.classList.add('md:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4'); break;
                    }
                },
                
                getColumnColspanClasses(count) {
                    switch (count) {
                        case 1: return '';
                        case 2: return 'md:col-span-2';
                        case 3: return 'md:col-span-2 lg:col-span-3';
                        case 4: return 'md:col-span-2 lg:col-span-3 xl:col-span-4';
                        default: return 'md:col-span-2';
                    }
                },
                // --- END: Column Count Functions ---

                renderAllDates() {
                    this.timers.forEach(timer => clearInterval(timer));
                    this.timers = [];
                    
                    try {
                        if (this.sortableGroups) {
                            this.sortableGroups.destroy();
                            this.sortableGroups = null; // Explicitly nullify
                        }
                    } catch (e) {
                        console.warn("Error destroying group Sortable:", e);
                    }
                    
                    try {
                        this.sortableCards.forEach(s => {
                            if (s) s.destroy();
                        });
                    } catch (e) {
                        console.warn("Error destroying card Sortable:", e);
                    }
                    this.sortableCards = [];
                    
                    this.countdownContainer.innerHTML = '';
                    
                    const dates = this.getDates(); // UPDATED
                    const groupOrder = this.getGroupOrder(); // UPDATED
                    const columnCount = this.getSettings().columnCount; // UPDATED

                    if (dates.length === 0) {
                        const colspanClasses = this.getColumnColspanClasses(columnCount); // UPDATED
                        this.countdownContainer.innerHTML = `
                            <div data-empty-state class="${colspanClasses} text-center text-muted mt-12 w-full">
                                <i data-lucide="calendar-days" class="w-16 h-16 mx-auto mb-4" stroke-width="1.5"></i>
                                <h3 class="text-xl font-semibold text-primary">No Dates Yet</h3>
                                <p class="text-muted">Click "Add Date" to get started.</p>
                            </div>
                        `;
                        lucide.createIcons(); // Render empty state icon
                        return;
                    }

                    const groupedDates = dates.reduce((acc, date) => {
                        const groupName = date.group || 'General';
                        if (!acc[groupName]) acc[groupName] = [];
                        acc[groupName].push(date);
                        return acc;
                    }, {});

                    for (const groupName in groupedDates) {
                        groupedDates[groupName].sort((a, b) => new Date(a.date) - new Date(b.date));
                    }

                    const allGroupNames = Object.keys(groupedDates);
                    let sortedGroupNames = groupOrder.filter(name => allGroupNames.includes(name));
                    allGroupNames.forEach(name => {
                        if (!sortedGroupNames.includes(name)) sortedGroupNames.push(name);
                    });
                    if (!groupOrder.includes('General') && sortedGroupNames.includes('General')) {
                        sortedGroupNames = sortedGroupNames.filter(name => name !== 'General');
                        sortedGroupNames.push('General');
                    }
                    
                    // UPDATED: Save new group order to current profile
                    this.appState.profileData[this.currentProfileId].groupOrder = sortedGroupNames;
                    this.saveAppState();


                    for (const groupName of sortedGroupNames) {
                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'group-container w-full';
                        groupContainer.dataset.groupName = groupName;

                        const groupHeader = document.createElement('h2');
                        groupHeader.className = 'group-header text-xl font-semibold text-primary w-full mb-3 mt-5 border-b border-color pb-2 flex items-center gap-2';
                        groupHeader.innerHTML = `
                            <i data-lucide="grip-vertical" class="w-4 h-4 text-muted shrink-0"></i>
                            ${this.escapeHTML(groupName)}
                        `;
                        
                        const cardList = document.createElement('div');
                        cardList.className = 'card-list';

                        for (const date of groupedDates[groupName]) {
                            const card = this.createDateCard(date);
                            cardList.appendChild(card);
                        }
                        
                        groupContainer.appendChild(groupHeader);
                        groupContainer.appendChild(cardList);
                        this.countdownContainer.appendChild(groupContainer);
                    }
                    
                    this.initSortable();
                    this.startTimers();
                    lucide.createIcons();
                },

                initSortable() {
                    // Check if Sortable is loaded
                    if (typeof Sortable === 'undefined') {
                        console.error('SortableJS is not loaded.');
                        this.showToast('Drag-and-drop failed to load. Please refresh.', 'error');
                        return;
                    }
                    
                    this.sortableGroups = new Sortable(this.countdownContainer, {
                        animation: 150,
                        handle: '.group-header',
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        onEnd: (evt) => this.handleGroupDrop(evt)
                    });

                    const cardLists = this.countdownContainer.querySelectorAll('.card-list');
                    cardLists.forEach(list => {
                        const sortableList = new Sortable(list, {
                            animation: 150,
                            group: 'goals',
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: (evt) => this.handleCardDrop(evt)
                        });
                        this.sortableCards.push(sortableList);
                    });
                },

                handleCardDrop(evt) {
                    const dateId = evt.item.dataset.id;
                    const newGroupEl = evt.to.closest('.group-container');
                    if (!newGroupEl) return;

                    const newGroupName = newGroupEl.dataset.groupName;
                    
                    const date = this.getDates().find(g => g.id === dateId); // UPDATED
                    if (date && date.group !== newGroupName) {
                        date.group = newGroupName;
                        this.saveAppState(); // UPDATED
                    }
                },

                handleGroupDrop(evt) {
                    const newOrder = Array.from(this.countdownContainer.children)
                        .map(el => el.dataset.groupName)
                        .filter(Boolean);
                    
                    this.appState.profileData[this.currentProfileId].groupOrder = newOrder; // UPDATED
                    this.saveAppState(); // UPDATED
                },

                calculateNextBirthday(dobString) {
                    try {
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const birthDate = new Date(dobString);
                        if (isNaN(birthDate.getTime())) throw new Error('Invalid date');
                        const birthMonth = birthDate.getMonth();
                        const birthDay = birthDate.getDate();
                        const birthYear = birthDate.getFullYear();
                        const currentYear = now.getFullYear();
                        let nextBirthdayDate = new Date(currentYear, birthMonth, birthDay);
                        let nextAge = currentYear - birthYear;
                        let currentAge = nextAge;
                        if (nextBirthdayDate < today) {
                            nextBirthdayDate.setFullYear(currentYear + 1);
                            nextAge = nextBirthdayDate.getFullYear() - birthYear;
                        } else {
                            currentAge = nextAge - 1;
                        }
                        if (nextBirthdayDate.getTime() === today.getTime()) {
                            currentAge = nextAge;
                        }
                        return { nextBirthdayDate, nextAge, currentAge };
                    } catch (e) {
                        console.error("Error calculating birthday:", e, dobString);
                        return { nextBirthdayDate: new Date(), nextAge: 0, currentAge: 0 };
                    }
                },

                calculateNextAnniversary(anniversaryDateString) {
                    try {
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const anniversaryDate = new Date(anniversaryDateString);
                        if (isNaN(anniversaryDate.getTime())) throw new Error('Invalid date');
                        const annivMonth = anniversaryDate.getMonth();
                        const annivDay = anniversaryDate.getDate();
                        const annivYear = anniversaryDate.getFullYear();
                        const currentYear = now.getFullYear();
                        let nextAnniversaryDate = new Date(currentYear, annivMonth, annivDay);
                        let nextAnniversaryNumber = currentYear - annivYear;
                        if (nextAnniversaryDate < today) {
                            nextAnniversaryDate.setFullYear(currentYear + 1);
                            nextAnniversaryNumber = nextAnniversaryDate.getFullYear() - annivYear;
                        }
                        return { nextAnniversaryDate, nextAnniversaryNumber };
                    } catch (e) {
                        console.error("Error calculating anniversary:", e, anniversaryDateString);
                        return { nextAnniversaryDate: new Date(), nextAnniversaryNumber: 0 };
                    }
                },

                calculateRemembranceInfo(dobString, dodString) {
                    try {
                        const dob = new Date(dobString);
                        const dod = new Date(dodString);
                        if (isNaN(dob.getTime()) || isNaN(dod.getTime())) throw new Error('Invalid date');
                        let livedForYears = dod.getFullYear() - dob.getFullYear();
                        const m = dod.getMonth() - dob.getMonth();
                        if (m < 0 || (m === 0 && dod.getDate() < dob.getDate())) {
                            livedForYears--;
                        }
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const dodMonth = dod.getMonth();
                        const dodDay = dod.getDate();
                        const currentYear = now.getFullYear();
                        const dodYear = dod.getFullYear();
                        let nextDeathAnniversary = new Date(currentYear, dodMonth, dodDay);
                        if (nextDeathAnniversary < today) {
                            nextDeathAnniversary.setFullYear(currentYear + 1);
                        }
                        return {
                            livedForYears: livedForYears,
                            nextDeathAnniversary: nextDeathAnniversary,
                            nextAnniversaryNumber: nextDeathAnniversary.getFullYear() - dodYear
                        };
                    } catch (e) {
                        console.error("Error calculating remembrance:", e, dobString, dodString);
                        return { livedForYears: 0, nextDeathAnniversary: new Date(), nextAnniversaryNumber: 0 };
                    }
                },

                createDateCard(dateData) {
                    const card = document.createElement('div');
                    card.className = 'card-bg p-2.5 rounded-lg shadow-lg flex flex-col space-y-2 w-40'; 
                    card.dataset.id = dateData.id;
                    
                    let targetDate, formattedDate, timerDateString, nextAge = 0, currentAge = 0, nextAnniversaryNumber = 0, livedForYears = 0, nextDeathAnniversaryNumber = 0;
                    const categoryLower = dateData.category.trim().toLowerCase();
                    const isRemembrance = dateData.isRemembrance && categoryLower === 'birthday';
                    let isBirthday = categoryLower === 'birthday' && !isRemembrance;
                    let isAnniversary = categoryLower === 'anniversary';
                    
                    if (isBirthday && dateData.date) {
                        const bdayInfo = this.calculateNextBirthday(dateData.date);
                        targetDate = bdayInfo.nextBirthdayDate;
                        timerDateString = targetDate.toISOString();
                        const originalBirthdate = new Date(dateData.date);
                        formattedDate = originalBirthdate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                        nextAge = bdayInfo.nextAge;
                        currentAge = bdayInfo.currentAge;
                    } else if (isAnniversary && dateData.date) {
                        const annivInfo = this.calculateNextAnniversary(dateData.date);
                        targetDate = annivInfo.nextAnniversaryDate;
                        timerDateString = targetDate.toISOString();
                        const originalAnnivDate = new Date(dateData.date);
                        formattedDate = originalAnnivDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                        nextAnniversaryNumber = annivInfo.nextAnniversaryNumber;
                    } else if (isRemembrance && dateData.date && dateData.dateOfDeath) {
                        const remInfo = this.calculateRemembranceInfo(dateData.date, dateData.dateOfDeath);
                        targetDate = remInfo.nextDeathAnniversary;
                        timerDateString = targetDate.toISOString();
                        livedForYears = remInfo.livedForYears;
                        nextDeathAnniversaryNumber = remInfo.nextAnniversaryNumber;
                        const originalBirthdate = new Date(dateData.date);
                        formattedDate = originalBirthdate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                    } else {
                        isBirthday = false;
                        isAnniversary = false;
                        targetDate = new Date(dateData.date);
                        timerDateString = dateData.date;
                        formattedDate = targetDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                    }
                    
                    const totalMilestones = dateData.milestones?.length || 0;
                    const completedMilestones = dateData.milestones?.filter(m => m.completed).length || 0;
                    
                    const milestoneDots = (totalMilestones > 0 ?
                        [...Array(totalMilestones)].map((_, i) => 
                            `<div class="w-1.5 h-1.5 rounded-full ${i < completedMilestones ? 'bg-accent-light' : 'bg-interactive'}"></div>`
                        ).join('') :
                        '<div class="w-1.5 h-1.5 rounded-full opacity-0"></div>'
                    );

                    const isComplete = dateData.status === 'Completed';
                    const completeClass = isComplete ? 'opacity-60' : '';
                    const completeIconClass = isComplete ? 'text-success' : 'text-muted-light';

                    const categoryBGColor = this.escapeHTML(dateData.categoryColor || '#374151');
                    const tagBGColor = this.escapeHTML(dateData.categoryColor || 'var(--bg-interactive)');
                    const categoryTextColor = this.getContrastingTextColor(categoryBGColor);
                    const iconColor = this.escapeHTML(dateData.categoryColor || 'var(--text-muted)');
                    
                    let categoryDisplay, categoryTitle;
                    if (isRemembrance) {
                        categoryDisplay = "Remembrance";
                        categoryTitle = "Category: Remembrance";
                    } else {
                        categoryDisplay = this.escapeHTML(dateData.category) || 'Misc';
                        categoryTitle = `Category: ${this.escapeHTML(dateData.category) || 'Misc'}`;
                    }

                    let lucideIconName = this.escapeHTML(dateData.iconName?.trim().toLowerCase());
                    if (!lucideIconName) {
                        if (isRemembrance) lucideIconName = 'flower-2';
                        else if (isBirthday) lucideIconName = 'cake';
                        else if (isAnniversary) lucideIconName = 'gift';
                        else {
                            const categoryName = dateData.category.trim().toLowerCase();
                            const categoryIconMap = { 'work': 'briefcase', 'personal': 'user', 'health': 'heart', 'learn': 'graduation-cap', 'finance': 'dollar-sign', 'travel': 'globe-2', 'home': 'home' };
                            lucideIconName = categoryIconMap[categoryName] || 'flag';
                        }
                    }
                    const iconSVG = `<i data-lucide="${lucideIconName}" class="w-3.5 h-3.5 shrink-0" style="stroke: ${iconColor};"></i>`;

                    let dateOrSpecialMessageHTML = '';
                    if (isBirthday) {
                        dateOrSpecialMessageHTML = `
                            <div class="flex items-center gap-1.5 text-accent-light ${completeClass}">
                                <i data-lucide="cake" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs font-medium" data-birthday-message></span>
                            </div>
                        `;
                    } else if (isAnniversary) {
                        dateOrSpecialMessageHTML = `
                            <div class="flex items-center gap-1.5 text-accent-light ${completeClass}">
                                <i data-lucide="gift" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs font-medium" data-anniversary-message></span>
                            </div>
                        `;
                    } else if (isRemembrance) {
                        dateOrSpecialMessageHTML = `
                            <div class="flex items-center gap-1.5 text-muted ${completeClass}">
                                <i data-lucide="user" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs font-medium">Lived for ${livedForYears} years</span>
                            </div>
                            <div class="flex items-center gap-1.5 text-accent-light ${completeClass}">
                                <i data-lucide="flower-2" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs font-medium" data-remembrance-anniversary-message></span>
                            </div>
                        `;
                    } else {
                        dateOrSpecialMessageHTML = `
                            <div class="flex items-center gap-1.5 text-muted ${completeClass}">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 shrink-0" stroke="currentColor"></i>
                                <span class="text-xs">${formattedDate}</span>
                            </div>
                        `;
                    }
                    
                    const isSpecialDate = isBirthday || isAnniversary || isRemembrance;
                    const showMilestones = dateData.showMilestones ?? true;
                    const milestoneSectionHTML = `
                        <div class="pt-0.5 ${completeClass}">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-muted">${isSpecialDate ? 'Checklist' : 'Milestones'}</span>
                                <span class="text-xs font-medium text-color">${completedMilestones} / ${totalMilestones}</span>
                            </div>
                            <div class="flex items-center gap-1 mt-1.5 h-1.5">
                                ${milestoneDots}
                            </div>
                        </div>
                    `;

                    card.innerHTML = `
                        <div class="flex items-start justify-between gap-1.5 ${completeClass}">
                            <div class="flex-col min-w-0">
                                <div class="flex items-center gap-1.5 min-w-0">
                                    ${iconSVG}
                                    <h3 class="text-sm font-semibold text-primary truncate" title="${this.escapeHTML(dateData.title)}">${this.escapeHTML(dateData.title)}</h3>
                                </div>
                            </div>
                            ${!isSpecialDate ? `
                                <div class="shrink-0 rounded-full ${isComplete ? 'bg-green-500' : 'border border-color-strong'} w-2.5 h-2.5 mt-0.5" title="Status: ${dateData.status}"></div>
                            ` : ''}
                        </div>

                        ${dateOrSpecialMessageHTML}
                        
                        ${showMilestones ? milestoneSectionHTML : ''}

                        <div class="relative flex justify-between gap-0.5 text-center ${completeClass}" data-date="${timerDateString}" data-id="${dateData.id}" data-time-container 
                             data-is-birthday="${isBirthday}" 
                             data-is-anniversary="${isAnniversary}" 
                             data-is-remembrance="${isRemembrance}" 
                             data-next-age="${nextAge}" 
                             data-next-anniversary-number="${nextAnniversaryNumber}"
                             data-next-death-anniversary-number="${nextDeathAnniversaryNumber}">
                            <div class="bg-interactive py-1 px-1 rounded w-auto min-w-[1.75rem]" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-days>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Days</span>
                            </div>
                            <div class="bg-interactive py-1 px-1 rounded w-7" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-hours>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Hrs</span>
                            </div>
                            <div class="bg-interactive py-1 px-1 rounded w-7" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-minutes>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Min</span>
                            </div>
                            <div class="bg-interactive py-1 px-1 rounded w-7" data-timer-segment>
                                <span class="block text-sm font-bold text-primary" data-seconds>0</span>
                                <span class="block text-[0.6rem] font-medium text-muted uppercase">Sec</span>
                            </div>
                            
                            <span class="absolute inset-0 flex items-center justify-center text-xs font-medium text-accent-light p-1 hidden" data-milestone-alert></span>
                        </div>
                        
                        <div class="text-center" data-non-birthday-alert-container></div>

                        <div class="flex items-center justify-between pt-1 border-t border-color min-w-0">
                            <div class="min-w-0"> 
                                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[0.65rem] font-medium ${completeClass} truncate" 
                                      style="background-color: ${tagBGColor}; color: ${categoryTextColor};" 
                                      title="${categoryTitle}">
                                    ${categoryDisplay}
                                </span>
                            </div>
                            <div class="flex items-center gap-0.5 shrink-0">
                                ${!isSpecialDate ? `
                                    <button class="complete-card p-1 text-muted-light hover-text-success rounded ${completeIconClass}" title="Toggle Complete">
                                        <i data-lucide="check" class="w-3.5 h-3.5"></i>
                                    </button>
                                ` : ''}
                                <button class="edit-card p-1 text-muted-light hover-text-accent-light rounded" title="Edit">
                                    <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                                </button>
                                <button class="delete-card p-1 text-muted-light hover-text-danger rounded" title="Delete">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    return card;
                },

                startTimers() {
                    const timerElements = this.countdownContainer.querySelectorAll('[data-date]');
                    timerElements.forEach(el => {
                        const timerId = setInterval(() => {
                            this.updateTimer(el);
                        }, 1000);
                        this.timers.push(timerId);
                        this.updateTimer(el);
                    });
                },

                updateTimer(el) {
                    const targetDate = new Date(el.dataset.date).getTime();
                    const now = new Date().getTime();
                    const distance = targetDate - now;

                    const isBirthday = el.dataset.isBirthday === 'true';
                    const isAnniversary = el.dataset.isAnniversary === 'true';
                    const isRemembrance = el.dataset.isRemembrance === 'true';
                    const nextAge = el.dataset.nextAge;
                    const nextAnniversaryNumber = el.dataset.nextAnniversaryNumber;
                    const nextDeathAnniversaryNumber = el.dataset.nextDeathAnniversaryNumber;

                    const daysEl = el.querySelector('[data-days]');
                    const hoursEl = el.querySelector('[data-hours]');
                    const minutesEl = el.querySelector('[data-minutes]');
                    const secondsEl = el.querySelector('[data-seconds]');
                    
                    const card = el.closest('.card-bg[data-id]');
                    if (!card) return; // Stop if card is gone

                    const birthdayMessageEl = card.querySelector('[data-birthday-message]');
                    const anniversaryMessageEl = card.querySelector('[data-anniversary-message]');
                    const remembranceAnniversaryMessageEl = card.querySelector('[data-remembrance-anniversary-message]');
                    const alertEl = el.querySelector('[data-milestone-alert]');
                    const nonBirthdayAlertContainer = card.querySelector('[data-non-birthday-alert-container]');
                    const timeContainer = el;
                    const timerSegments = el.querySelectorAll('[data-timer-segment]');


                    if (distance < 0) {
                        const daysAgo = Math.floor(Math.abs(distance) / (1000 * 60 * 60 * 24));
                        let pastMessage;
                        
                        const absDist = Math.abs(distance);
                        const isToday = absDist < (1000 * 60 * 60 * 24);

                        if (isBirthday) {
                            pastMessage = isToday ? `Happy ${this.getOrdinal(nextAge)} Birthday!` : `Birthday passed (Turned ${nextAge})`;
                            if (timeContainer) {
                                timeContainer.innerHTML = `<div class="text-xs text-center font-bold text-accent-light py-1 px-1 w-full">${pastMessage}</div>`;
                            }
                        } else if (isAnniversary) {
                            pastMessage = isToday ? `Happy ${this.getOrdinal(nextAnniversaryNumber)} Anniversary!` : `Anniversary passed (${this.getOrdinal(nextAnniversaryNumber)})`;
                            if (timeContainer) {
                                timeContainer.innerHTML = `<div class="text-xs text-center font-bold text-accent-light py-1 px-1 w-full">${pastMessage}</div>`;
                            }
                        } else if (isRemembrance) {
                            pastMessage = isToday ? `${this.getOrdinal(nextDeathAnniversaryNumber)} Anniversary` : `${this.getOrdinal(nextDeathAnniversaryNumber)} Anniversary passed`;
                            if (timeContainer) {
                                timeContainer.innerHTML = `<div class="text-xs text-center font-bold text-accent-light py-1 px-1 w-full">${pastMessage}</div>`;
                            }
                        } else if (daysAgo === 0) {
                            pastMessage = "Today!";
                            if (timeContainer) {
                                timeContainer.innerHTML = `<div class="text-xs text-center text-muted py-1 px-1 w-full">${pastMessage}</div>`;
                            }
                        } else { // This covers 1 day ago and "X days ago"
                            const daysAgoText = daysAgo === 1 ? 'Day Ago' : 'Days Ago';
                            if (timeContainer) {
                                timeContainer.innerHTML = `
                                    <div class="bg-interactive py-1 px-1 rounded w-full text-center">
                                        <span class="block text-xl font-bold text-primary">${daysAgo}</span>
                                        <span class="block text-[0.6rem] font-medium text-muted uppercase">${daysAgoText}</span>
                                    </div>
                                `;
                            }
                        }
                        
                        if (birthdayMessageEl) birthdayMessageEl.innerHTML = '';
                        if (anniversaryMessageEl) anniversaryMessageEl.innerHTML = '';
                        if (remembranceAnniversaryMessageEl) remembranceAnniversaryMessageEl.innerHTML = '';
                        if (nonBirthdayAlertContainer) nonBirthdayAlertContainer.innerHTML = '';
                        return;
                    }

                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    if (daysEl) daysEl.textContent = days;
                    if (hoursEl) hoursEl.textContent = String(hours).padStart(2, '0');
                    if (minutesEl) minutesEl.textContent = String(minutes).padStart(2, '0');
                    if (secondsEl) secondsEl.textContent = String(seconds).padStart(2, '0');
                    
                    if (isBirthday) {
                        if (birthdayMessageEl) birthdayMessageEl.textContent = `Turning ${nextAge} in`;
                        if (anniversaryMessageEl) anniversaryMessageEl.textContent = '';
                        if (remembranceAnniversaryMessageEl) remembranceAnniversaryMessageEl.textContent = '';
                        if (alertEl) alertEl.classList.add('hidden'); 
                        if (nonBirthdayAlertContainer) nonBirthdayAlertContainer.innerHTML = ''; 
                        if (timerSegments) timerSegments.forEach(seg => seg.style.visibility = 'visible');
                    } else if (isAnniversary) {
                        if (anniversaryMessageEl) anniversaryMessageEl.textContent = `${this.getOrdinal(nextAnniversaryNumber)} Anniversary in`;
                        if (birthdayMessageEl) birthdayMessageEl.textContent = '';
                        if (remembranceAnniversaryMessageEl) remembranceAnniversaryMessageEl.textContent = '';
                        if (alertEl) alertEl.classList.add('hidden'); 
                        if (nonBirthdayAlertContainer) nonBirthdayAlertContainer.innerHTML = ''; 
                        if (timerSegments) timerSegments.forEach(seg => seg.style.visibility = 'visible');
                    } else if (isRemembrance) {
                        if (remembranceAnniversaryMessageEl) remembranceAnniversaryMessageEl.textContent = `${this.getOrdinal(nextDeathAnniversaryNumber)} Anniversary in`;
                        if (birthdayMessageEl) birthdayMessageEl.textContent = '';
                        if (anniversaryMessageEl) anniversaryMessageEl.textContent = '';
                        if (alertEl) alertEl.classList.add('hidden'); 
                        if (nonBirthdayAlertContainer) nonBirthdayAlertContainer.innerHTML = ''; 
                        if (timerSegments) timerSegments.forEach(seg => seg.style.visibility = 'visible');
                    } else {
                        if (birthdayMessageEl) birthdayMessageEl.textContent = '';
                        if (anniversaryMessageEl) anniversaryMessageEl.textContent = '';
                        if (remembranceAnniversaryMessageEl) remembranceAnniversaryMessageEl.textContent = '';
                        if (alertEl) {
                            alertEl.textContent = ''; 
                            alertEl.classList.add('hidden'); 
                        }
                        if (timerSegments) timerSegments.forEach(seg => seg.style.visibility = 'visible');
                        if (nonBirthdayAlertContainer) {
                            nonBirthdayAlertContainer.innerHTML = '';
                        }
                    }
                },
                
                getOrdinal(n) {
                    if (n === null || n === undefined) return '';
                    const s = ['th', 'st', 'nd', 'rd'];
                    const v = n % 100;
                    return n + (s[(v - 20) % 10] || s[v] || s[0]);
                },

                getMilestoneAlert(distance, days) {
                    // ... (This function is no longer used, but kept for posterity)
                    return '';
                },

                updateDatalists() {
                    const dates = this.getDates(); // UPDATED
                    const categories = [...new Set(dates.map(g => g.category).filter(Boolean))];
                    const groups = [...new Set(dates.map(g => g.group).filter(Boolean))];

                    this.categorySuggestions.innerHTML = categories.map(c => `<option value="${this.escapeHTML(c)}"></option>`).join('');
                    this.groupSuggestions.innerHTML = groups.map(g => `<option value="${this.escapeHTML(g)}"></option>`).join('');
                },
                
                escapeHTML(str) {
                    if (str === null || str === undefined) {
                        return '';
                    }
                    return str.toString()
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                },

                getContrastingTextColor(hexColor) {
                    if (!hexColor) return 'var(--text-primary)';
                    hexColor = hexColor.replace(/^#/, '');
                    let r, g, b;
                    if (hexColor.length === 3) {
                        r = parseInt(hexColor.substring(0, 1) + hexColor.substring(0, 1), 16);
                        g = parseInt(hexColor.substring(1, 2) + hexColor.substring(1, 2), 16);
                        b = parseInt(hexColor.substring(2, 3) + hexColor.substring(2, 3), 16);
                    } else if (hexColor.length === 6) {
                        r = parseInt(hexColor.substring(0, 2), 16);
                        g = parseInt(hexColor.substring(2, 4), 16);
                        b = parseInt(hexColor.substring(4, 6), 16);
                    } else {
                        return 'var(--text-primary)';
                    }
                    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    return luminance > 0.5 ? '#000000' : '#FFFFFF';
                },
            };
            app.init();
        });
    </script>

</body>
</html>
